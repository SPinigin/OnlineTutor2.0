@model OnlineTutor2.ViewModels.AdminStatisticsViewModel
@{
    ViewData["Title"] = "Статистика";
}

@await Html.PartialAsync("_AdminNav")

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-chart-bar text-success"></i> Статистика и аналитика</h2>
        <p class="text-muted">Визуализация данных системы за последние 30 дней</p>
    </div>
    <div>
        <button class="btn btn-outline-primary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Обновить
        </button>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> К дашборду
        </a>
    </div>
</div>


<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <i class="fas fa-user-check text-success" style="font-size: 2rem;"></i>
                <h3 class="mt-2 text-success">@Model.ActiveUsers</h3>
                <p class="text-muted mb-0">Активных пользователей</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-secondary">
            <div class="card-body">
                <i class="fas fa-user-slash text-secondary" style="font-size: 2rem;"></i>
                <h3 class="mt-2 text-secondary">@Model.InactiveUsers</h3>
                <p class="text-muted mb-0">Неактивных пользователей</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <i class="fas fa-tasks text-primary" style="font-size: 2rem;"></i>
                <h3 class="mt-2 text-primary">@Model.TestsByType.Values.Sum()</h3>
                <p class="text-muted mb-0">Всего тестов</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <i class="fas fa-chart-line text-info" style="font-size: 2rem;"></i>
                <h3 class="mt-2 text-info">@Model.TestResultsByDate.Values.Sum()</h3>
                <p class="text-muted mb-0">Результатов за 30 дней</p>
            </div>
        </div>
    </div>
</div>


<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user-plus"></i> Регистрации пользователей (30 дней)
                </h5>
            </div>
            <div class="card-body">
                <canvas id="registrationsChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-check"></i> Прохождение тестов (30 дней)
                </h5>
            </div>
            <div class="card-body">
                <canvas id="testResultsChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>


<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-tasks"></i> Распределение тестов по типам
                </h5>
            </div>
            <div class="card-body">
                <canvas id="testsByTypeChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-percentage"></i> Средний балл по типам тестов
                </h5>
            </div>
            <div class="card-body">
                <canvas id="averageScoresChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>


<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-bolt"></i> Топ действий администраторов
                </h5>
            </div>
            <div class="card-body">
                <canvas id="adminActionsChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-week"></i> Активность по дням недели
                </h5>
            </div>
            <div class="card-body">
                <canvas id="activityByDayChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>


<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-trophy"></i> Топ учителей по тестам
                </h5>
            </div>
            <div class="card-body">
                <canvas id="topTeachersChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-medal"></i> Топ студентов по результатам
                </h5>
            </div>
            <div class="card-body">
                <canvas id="topStudentsChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>


<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-users"></i> Статус пользователей
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="userStatusChart" height="150"></canvas>
                    </div>
                    <div class="col-md-6 d-flex align-items-center justify-content-center">
                        <div class="text-center">
                            <h2 class="text-success">@Model.ActiveUsers</h2>
                            <p class="text-muted">Активные пользователи</p>
                            <h2 class="text-secondary">@Model.InactiveUsers</h2>
                            <p class="text-muted">Неактивные пользователи</p>
                            @{
                                var total = Model.ActiveUsers + Model.InactiveUsers;
                                var activePercent = total > 0 ? Math.Round((double)Model.ActiveUsers / total * 100, 1) : 0;
                            }
                            <div class="mt-3">
                                <h4 class="text-primary">@activePercent%</h4>
                                <p class="text-muted">Активность пользователей</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Цветовая палитра
        const colors = {
            primary: 'rgba(0, 123, 255, 0.8)',
            success: 'rgba(40, 167, 69, 0.8)',
            danger: 'rgba(220, 53, 69, 0.8)',
            warning: 'rgba(255, 193, 7, 0.8)',
            info: 'rgba(23, 162, 184, 0.8)',
            secondary: 'rgba(108, 117, 125, 0.8)',
            primaryBorder: 'rgba(0, 123, 255, 1)',
            successBorder: 'rgba(40, 167, 69, 1)',
            dangerBorder: 'rgba(220, 53, 69, 1)',
            warningBorder: 'rgba(255, 193, 7, 1)',
            infoBorder: 'rgba(23, 162, 184, 1)',
            secondaryBorder: 'rgba(108, 117, 125, 1)'
        };

        // 1. Регистрации пользователей
        const registrationsData = @Html.Raw(Json.Serialize(Model.UserRegistrationsByDate));
        new Chart(document.getElementById('registrationsChart'), {
            type: 'line',
            data: {
                labels: Object.keys(registrationsData).map(d => new Date(d).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' })),
                datasets: [{
                    label: 'Регистрации',
                    data: Object.values(registrationsData),
                    borderColor: colors.primaryBorder,
                    backgroundColor: colors.primary,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });

        // 2. Прохождение тестов
        const testResultsData = @Html.Raw(Json.Serialize(Model.TestResultsByDate));
        new Chart(document.getElementById('testResultsChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(testResultsData).map(d => new Date(d).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' })),
                datasets: [{
                    label: 'Результаты',
                    data: Object.values(testResultsData),
                    backgroundColor: colors.info,
                    borderColor: colors.infoBorder,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });

        // 3. Тесты по типам
        const testsByType = @Html.Raw(Json.Serialize(Model.TestsByType));
        new Chart(document.getElementById('testsByTypeChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(testsByType),
                datasets: [{
                    data: Object.values(testsByType),
                    backgroundColor: [colors.primary, colors.success, colors.danger, colors.warning],
                    borderColor: [colors.primaryBorder, colors.successBorder, colors.dangerBorder, colors.warningBorder],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // 4. Средний балл
        const averageScores = @Html.Raw(Json.Serialize(Model.AverageScoresByType));
        new Chart(document.getElementById('averageScoresChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(averageScores),
                datasets: [{
                    label: 'Средний балл (%)',
                    data: Object.values(averageScores),
                    backgroundColor: [colors.primary, colors.success, colors.danger, colors.warning],
                    borderColor: [colors.primaryBorder, colors.successBorder, colors.dangerBorder, colors.warningBorder],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });

        // 5. Действия администраторов
        const adminActions = @Html.Raw(Json.Serialize(Model.AdminActionsByType));
        new Chart(document.getElementById('adminActionsChart'), {
            type: 'horizontalBar',
            data: {
                labels: Object.keys(adminActions),
                datasets: [{
                    label: 'Количество',
                    data: Object.values(adminActions),
                    backgroundColor: colors.danger,
                    borderColor: colors.dangerBorder,
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });

        // 6. Активность по дням недели
        const activityByDay = @Html.Raw(Json.Serialize(Model.ActivityByDayOfWeek));
        new Chart(document.getElementById('activityByDayChart'), {
            type: 'radar',
            data: {
                labels: Object.keys(activityByDay),
                datasets: [{
                    label: 'Активность',
                    data: Object.values(activityByDay),
                    backgroundColor: colors.secondary,
                    borderColor: colors.secondaryBorder,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    r: { beginAtZero: true }
                }
            }
        });

        // 7. Топ учителей
        const topTeachers = @Html.Raw(Json.Serialize(Model.TopTeachersByTests));
        new Chart(document.getElementById('topTeachersChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(topTeachers),
                datasets: [{
                    label: 'Тестов создано',
                    data: Object.values(topTeachers),
                    backgroundColor: colors.success,
                    borderColor: colors.successBorder,
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });

        // 8. Топ студентов
        const topStudents = @Html.Raw(Json.Serialize(Model.TopStudentsByResults));
        new Chart(document.getElementById('topStudentsChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(topStudents),
                datasets: [{
                    label: 'Тестов пройдено',
                    data: Object.values(topStudents),
                    backgroundColor: colors.info,
                    borderColor: colors.infoBorder,
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });

        // 9. Статус пользователей
        new Chart(document.getElementById('userStatusChart'), {
            type: 'pie',
            data: {
                labels: ['Активные', 'Неактивные'],
                datasets: [{
                    data: [@Model.ActiveUsers, @Model.InactiveUsers],
                    backgroundColor: [colors.success, colors.secondary],
                    borderColor: [colors.successBorder, colors.secondaryBorder],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    </script>
}
