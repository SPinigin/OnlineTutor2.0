@using OnlineTutor2.Models
@{
    ViewData["Title"] = "Результат теста";

    // Определяем тип результата
    var spellingResult = Model as SpellingTestResult;
    var punctuationResult = Model as PunctuationTestResult;
    var orthoeopyResult = Model as OrthoeopyTestResult;
    var regularResult = Model as RegularTestResult;

    var isSpellingResult = spellingResult != null;
    var isPunctuationResult = punctuationResult != null;
    var isOrthoeopyResult = orthoeopyResult != null;
    var isRegularResult = regularResult != null;

    string testTitle = "";
    int score = 0;
    int maxScore = 0;
    double percentage = 0;
    DateTime? completedAt = null;
    DateTime startedAt = DateTime.Now;
    TimeSpan duration = TimeSpan.Zero;
    string studentName = "";
    bool showCorrectAnswers = false;
    string testIcon = "";
    string testColor = "";

    if (isSpellingResult)
    {
        testTitle = spellingResult.SpellingTest.Title;
        score = spellingResult.Score;
        maxScore = spellingResult.MaxScore;
        percentage = spellingResult.Percentage;
        completedAt = spellingResult.CompletedAt;
        startedAt = spellingResult.StartedAt;
        studentName = spellingResult.Student.User.FullName;
        showCorrectAnswers = spellingResult.SpellingTest.ShowCorrectAnswers;
        testIcon = "fa-spell-check";
        testColor = "primary";
    }
    else if (isPunctuationResult)
    {
        testTitle = punctuationResult.PunctuationTest.Title;
        score = punctuationResult.Score;
        maxScore = punctuationResult.MaxScore;
        percentage = punctuationResult.Percentage;
        completedAt = punctuationResult.CompletedAt;
        startedAt = punctuationResult.StartedAt;
        studentName = punctuationResult.Student.User.FullName;
        showCorrectAnswers = punctuationResult.PunctuationTest.ShowCorrectAnswers;
        testIcon = "fa-quote-right";
        testColor = "danger";
    }
    else if (isOrthoeopyResult)
    {
        testTitle = orthoeopyResult.OrthoeopyTest.Title;
        score = orthoeopyResult.Score;
        maxScore = orthoeopyResult.MaxScore;
        percentage = orthoeopyResult.Percentage;
        completedAt = orthoeopyResult.CompletedAt;
        startedAt = orthoeopyResult.StartedAt;
        studentName = orthoeopyResult.Student.User.FullName;
        showCorrectAnswers = orthoeopyResult.OrthoeopyTest.ShowCorrectAnswers;
        testIcon = "fa-volume-up";
        testColor = "warning";
    }
    else if (isRegularResult)
    {
        testTitle = regularResult.RegularTest.Title;
        score = regularResult.Score;
        maxScore = regularResult.MaxScore;
        percentage = regularResult.Percentage;
        completedAt = regularResult.CompletedAt;
        startedAt = regularResult.StartedAt;
        studentName = regularResult.Student.User.FullName;
        showCorrectAnswers = regularResult.RegularTest.ShowCorrectAnswers;
        testIcon = "fa-list-ul";
        testColor = "success";
    }

    if (completedAt.HasValue)
    {
        duration = completedAt.Value - startedAt;
    }

    var gradeColor = percentage >= 80 ? "success" :
                     percentage >= 60 ? "warning" :
                     percentage >= 40 ? "info" : "danger";

    var grade = percentage >= 91 ? 5 :
                percentage >= 76 ? 4 :
                percentage >= 61 ? 3 : 2;
}

<div class="result-container">

    <div class="mb-4 text-center">
        <h2>
            <i class="fas @testIcon text-@testColor"></i> @testTitle
        </h2>
    </div>


    <div class="card mb-4 shadow-lg">
        <div class="card-body text-center p-5">
            <div class="mb-4">
                <i class="fas fa-flag-checkered text-@gradeColor" style="font-size: 4rem;"></i>
            </div>
            <h2 class="mb-3">Тест завершен!</h2>

            <div class="result-score mb-4">
                <div class="display-4 text-@gradeColor mb-2">@score / @maxScore</div>
                <div class="h5 text-muted">баллов</div>
            </div>

            <div class="result-circle mx-auto mb-4" style="width: 200px; height: 200px;">
                <svg viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#e9ecef" stroke-width="8" />
                    <circle cx="50" cy="50" r="45" fill="none"
                            stroke="@(percentage >= 80 ? "#28a745" : percentage >= 60 ? "#ffc107" : percentage >= 40 ? "#17a2b8" : "#dc3545")"
                            stroke-width="8"
                            stroke-dasharray="@(percentage * 2.827), 282.7"
                            transform="rotate(-90 50 50)" />
                    <text x="50" y="50" text-anchor="middle" dy="7"
                          font-size="20" font-weight="bold"
                          fill="@(percentage >= 80 ? "#28a745" : percentage >= 60 ? "#ffc107" : percentage >= 40 ? "#17a2b8" : "#dc3545")">
                        @percentage.ToString("F1")%
                    </text>
                </svg>
            </div>

            <div class="grade-display mb-4">
                <span class="badge bg-@gradeColor fs-3 px-4 py-2">
                    Оценка: @grade
                </span>
            </div>

            <div class="row text-center mt-4">
                <div class="col-md-4">
                    <i class="fas fa-user-graduate text-muted fa-2x"></i>
                    <div class="mt-2">
                        <small class="text-muted">Ученик</small>
                        <div><strong>@studentName</strong></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <i class="fas fa-calendar text-muted fa-2x"></i>
                    <div class="mt-2">
                        <small class="text-muted">Дата и время</small>
                        <div><strong>@completedAt?.ToString("dd.MM.yyyy HH:mm")</strong></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <i class="fas fa-stopwatch text-muted fa-2x"></i>
                    <div class="mt-2">
                        <small class="text-muted">Время выполнения</small>
                        <div><strong>@($"{duration.Minutes:D2}:{duration.Seconds:D2}")</strong></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    @if (showCorrectAnswers)
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt"></i> Детальные результаты
                </h5>
            </div>
            <div class="card-body">
                @if (isSpellingResult)
                {

                    @foreach (var question in spellingResult.SpellingTest.SpellingQuestions.OrderBy(q => q.OrderIndex))
                    {
                        var answer = spellingResult.SpellingAnswers.FirstOrDefault(a => a.SpellingQuestionId == question.Id);
                        var isCorrect = answer?.IsCorrect ?? false;
                        var questionIndex = spellingResult.SpellingTest.SpellingQuestions.OrderBy(q => q.OrderIndex).ToList().IndexOf(question) + 1;

                        <div class="question-result mb-4 p-3 border rounded border-@(isCorrect ? "success" : "danger")">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-@(isCorrect ? "success" : "danger") me-2">@questionIndex</span>
                                        <h6 class="mb-0">@question.WordWithGap</h6>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <small class="text-muted">Ваш ответ:</small>
                                            <div class="fw-bold text-@(isCorrect ? "success" : "danger")">
                                                @if (!string.IsNullOrEmpty(answer?.StudentAnswer))
                                                {
                                                    <span>"@answer.StudentAnswer"</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Не отвечено</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">Правильный ответ:</small>
                                            <div class="fw-bold text-success">
                                                "@question.CorrectLetter" → @question.FullWord
                                            </div>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(question.Hint))
                                    {
                                        <div class="mt-3 p-2 bg-info bg-opacity-10 rounded">
                                            <small class="text-muted"><i class="fas fa-lightbulb"></i> Подсказка:</small>
                                            <div class="small">@question.Hint</div>
                                        </div>
                                    }
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="result-icon">
                                        @if (isCorrect)
                                        {
                                            <i class="fas fa-check-circle text-success fa-3x"></i>
                                            <div class="mt-2">
                                                <span class="badge bg-success fs-6">+@question.Points баллов</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <i class="fas fa-times-circle text-danger fa-3x"></i>
                                            <div class="mt-2">
                                                <span class="badge bg-danger fs-6">0 баллов</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else if (isPunctuationResult)
                {

                    @foreach (var question in punctuationResult.PunctuationTest.PunctuationQuestions.OrderBy(q => q.OrderIndex))
                    {
                        var answer = punctuationResult.PunctuationAnswers.FirstOrDefault(a => a.PunctuationQuestionId == question.Id);
                        var isCorrect = answer?.IsCorrect ?? false;
                        var questionIndex = punctuationResult.PunctuationTest.PunctuationQuestions.OrderBy(q => q.OrderIndex).ToList().IndexOf(question) + 1;

                        <div class="question-result mb-4 p-3 border rounded border-@(isCorrect ? "success" : "danger")">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-3">
                                        <span class="badge bg-@(isCorrect ? "success" : "danger") me-2">@questionIndex</span>
                                        <h6 class="mb-0">Расставьте знаки препинания</h6>
                                    </div>

                                    <div class="mb-3">
                                        <small class="text-muted">Предложение:</small>
                                        <div class="p-3 bg-light rounded">
                                            @question.SentenceWithNumbers
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">Ваш ответ:</small>
                                            <div class="fw-bold text-@(isCorrect ? "success" : "danger")">
                                                @if (!string.IsNullOrEmpty(answer?.StudentAnswer))
                                                {
                                                    <span>Позиции: @answer.StudentAnswer</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Не отвечено</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">Правильный ответ:</small>
                                            <div class="fw-bold text-success">
                                                @if (!string.IsNullOrEmpty(question.CorrectPositions))
                                                {
                                                    <span>Позиции: @question.CorrectPositions</span>
                                                }
                                                else
                                                {
                                                    <span>Без запятых</span>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(question.PlainSentence))
                                    {
                                        <div class="mt-3 p-3 bg-success bg-opacity-10 rounded border-start border-success border-3">
                                            <small class="text-muted">Правильный вариант:</small>
                                            <div class="fw-bold">@question.PlainSentence</div>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(question.Hint))
                                    {
                                        <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                                            <small class="text-muted"><i class="fas fa-lightbulb"></i> Подсказка:</small>
                                            <div class="small">@question.Hint</div>
                                        </div>
                                    }
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="result-icon">
                                        @if (isCorrect)
                                        {
                                            <i class="fas fa-check-circle text-success fa-3x"></i>
                                            <div class="mt-2">
                                                <span class="badge bg-success fs-6">+@question.Points баллов</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <i class="fas fa-times-circle text-danger fa-3x"></i>
                                            <div class="mt-2">
                                                <span class="badge bg-danger fs-6">0 баллов</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else if (isOrthoeopyResult)
                {

                    @foreach (var question in orthoeopyResult.OrthoeopyTest.OrthoeopyQuestions.OrderBy(q => q.OrderIndex))
                    {
                        var answer = orthoeopyResult.OrthoeopyAnswers.FirstOrDefault(a => a.OrthoeopyQuestionId == question.Id);
                        var isCorrect = answer?.IsCorrect ?? false;
                        var questionIndex = orthoeopyResult.OrthoeopyTest.OrthoeopyQuestions.OrderBy(q => q.OrderIndex).ToList().IndexOf(question) + 1;

                        <div class="question-result mb-4 p-3 border rounded border-@(isCorrect ? "success" : "danger")">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-@(isCorrect ? "success" : "danger") me-2">@questionIndex</span>
                                        <h6 class="mb-0">Выберите правильное ударение</h6>
                                    </div>

                                    <div class="mb-3">
                                        <small class="text-muted">Слово:</small>
                                        <div class="p-2 bg-light rounded">
                                            <span class="h5">@question.Word</span>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">Ваш ответ:</small>
                                            <div class="fw-bold text-@(isCorrect ? "success" : "danger")">
                                                @if (answer?.SelectedStressPosition.HasValue == true)
                                                {
                                                    <span>Ударение на @answer.SelectedStressPosition слог</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Не отвечено</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">Правильный ответ:</small>
                                            <div class="fw-bold text-success">
                                                <span class="h5">@question.WordWithStress</span>
                                                <br>
                                                <small>(ударение на @question.StressPosition слог)</small>
                                            </div>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(question.Hint))
                                    {
                                        <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                                            <small class="text-muted"><i class="fas fa-lightbulb"></i> Подсказка:</small>
                                            <div class="small">@question.Hint</div>
                                        </div>
                                    }
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="result-icon">
                                        @if (isCorrect)
                                        {
                                            <i class="fas fa-check-circle text-success fa-3x"></i>
                                            <div class="mt-2">
                                                <span class="badge bg-success fs-6">+@question.Points баллов</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <i class="fas fa-times-circle text-danger fa-3x"></i>
                                            <div class="mt-2">
                                                <span class="badge bg-danger fs-6">0 баллов</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else if (isRegularResult)
                {

                    <div class="accordion" id="questionsAccordion">
                        @for (int i = 0; i < regularResult.RegularTest.RegularQuestions.Count; i++)
                        {
                            var question = regularResult.RegularTest.RegularQuestions.OrderBy(q => q.OrderIndex).ElementAt(i);
                            var answer = regularResult.RegularAnswers.FirstOrDefault(a => a.QuestionId == question.Id);
                            var isAnswered = answer != null;
                            var isCorrect = answer?.IsCorrect ?? false;

                            var selectedIds = new List<int>();
                            if (!string.IsNullOrEmpty(answer?.SelectedOptionIds))
                            {
                                selectedIds = answer.SelectedOptionIds.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(id => int.Parse(id.Trim())).ToList();
                            }

                            <div class="accordion-item border-@(isAnswered ? (isCorrect ? "success" : "danger") : "secondary") mb-2">
                                <h2 class="accordion-header" id="heading@i">
                                    <button class="accordion-button @(i > 0 ? "collapsed" : "")" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapse@i">
                                        <div class="w-100 d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="badge bg-secondary me-2">Вопрос @(i + 1)</span>
                                                <span class="badge bg-@(question.Type == QuestionType.SingleChoice ? "primary" : question.Type == QuestionType.MultipleChoice ? "success" : "warning") me-2">
                                                    <i class="fas @question.Type.GetIcon()"></i> @question.Type.GetDisplayName()
                                                </span>
                                                <span>@question.Text</span>
                                            </div>
                                            <div class="ms-3">
                                                @if (isAnswered)
                                                {
                                                    @if (isCorrect)
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-check"></i> +@answer.Points б.
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-times"></i> 0 б.
                                                        </span>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Не отвечено</span>
                                                }
                                            </div>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse@i" class="accordion-collapse collapse @(i == 0 ? "show" : "")"
                                     data-bs-parent="#questionsAccordion">
                                    <div class="accordion-body">
                                        @if (!string.IsNullOrEmpty(question.Hint))
                                        {
                                            <div class="alert alert-info mb-3">
                                                <i class="fas fa-lightbulb"></i>
                                                <strong>Подсказка:</strong> @question.Hint
                                            </div>
                                        }


                                        <div class="mb-3">
                                            @foreach (var option in question.Options.OrderBy(o => o.OrderIndex))
                                            {
                                                var isSelected = selectedIds.Contains(option.Id);
                                                var cardClass = "";
                                                var borderClass = "";

                                                if (option.IsCorrect)
                                                {
                                                    cardClass = "bg-success bg-opacity-10";
                                                    borderClass = "border-success border-2";
                                                }
                                                else if (isSelected)
                                                {
                                                    cardClass = "bg-danger bg-opacity-10";
                                                    borderClass = "border-danger border-2";
                                                }

                                                <div class="card mb-2 @cardClass @borderClass">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="flex-grow-1">
                                                                @if (question.Type == QuestionType.MultipleChoice)
                                                                {
                                                                    @if (isSelected)
                                                                    {
                                                                        <i class="fas fa-check-square text-primary me-2"></i>
                                                                    }
                                                                    else
                                                                    {
                                                                        <i class="far fa-square text-muted me-2"></i>
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    @if (isSelected)
                                                                    {
                                                                        <i class="fas fa-dot-circle text-primary me-2"></i>
                                                                    }
                                                                    else
                                                                    {
                                                                        <i class="far fa-circle text-muted me-2"></i>
                                                                    }
                                                                }
                                                                <strong>@option.Text</strong>
                                                            </div>
                                                            <div>
                                                                @if (option.IsCorrect)
                                                                {
                                                                    <span class="badge bg-success">
                                                                        <i class="fas fa-check"></i> Правильно
                                                                    </span>
                                                                }
                                                                @if (isSelected && !option.IsCorrect)
                                                                {
                                                                    <span class="badge bg-danger">
                                                                        <i class="fas fa-times"></i> Ваш выбор
                                                                    </span>
                                                                }
                                                            </div>
                                                        </div>

                                                        @if (!string.IsNullOrEmpty(option.Explanation))
                                                        {
                                                            <small class="text-muted d-block mt-2">
                                                                <i class="fas fa-info-circle"></i> @option.Explanation
                                                            </small>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        @if (!string.IsNullOrEmpty(question.Explanation))
                                        {
                                            <div class="alert alert-success">
                                                <i class="fas fa-graduation-cap"></i>
                                                <strong>Объяснение:</strong> @question.Explanation
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <i class="fas fa-eye-slash fa-2x mb-3"></i>
            <h5>Детальные результаты скрыты</h5>
            <p class="mb-0">Учитель отключил показ правильных ответов для этого теста</p>
        </div>
    }


    <div class="d-flex justify-content-between">
        <a asp-action="Index" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left"></i> К списку тестов
        </a>
        <a asp-action="History" class="btn btn-outline-info">
            <i class="fas fa-history"></i> История прохождений
        </a>
    </div>
</div>

@section Styles {
    <style>
        .result-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .result-circle {
            position: relative;
        }

            .result-circle svg {
                transform: rotate(0deg);
            }

        .question-result {
            background-color: #fff;
            transition: all 0.3s ease;
        }

            .question-result:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

        .result-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .grade-display {
            animation: scaleIn 0.5s ease;
        }

        @@keyframes scaleIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .accordion-button:not(.collapsed) {
            background-color: #f8f9fa;
        }
    </style>
}

@section Scripts {
    <script>
        // Анимация круговой диаграммы при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            const circle = document.querySelector('.result-circle circle:nth-child(2)');
            if (circle) {
                circle.style.transition = 'stroke-dasharray 1s ease';
            }
        });
    </script>
}
