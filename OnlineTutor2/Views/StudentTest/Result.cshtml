@using OnlineTutor2.Models
@{
    ViewData["Title"] = "Результат теста";

    // Определяем тип результата
    var spellingResult = Model as SpellingTestResult;
    var punctuationResult = Model as PunctuationTestResult;
    var orthoeopyResult = Model as OrthoeopyTestResult;
    var regularResult = Model as RegularTestResult;

    var isSpellingResult = spellingResult != null;
    var isPunctuationResult = punctuationResult != null;
    var isOrthoeopyResult = orthoeopyResult != null;
    var isRegularResult = regularResult != null;

    string testTitle = "";
    int score = 0;
    int maxScore = 0;
    double percentage = 0;
    DateTime? completedAt = null;
    DateTime startedAt = DateTime.Now;
    TimeSpan duration = TimeSpan.Zero;
    string studentName = "";
    bool showCorrectAnswers = false;
    string testIcon = "";
    string testColor = "";

    if (isSpellingResult)
    {
        testTitle = spellingResult.SpellingTest.Title;
        score = spellingResult.Score;
        maxScore = spellingResult.MaxScore;
        percentage = spellingResult.Percentage;
        completedAt = spellingResult.CompletedAt;
        startedAt = spellingResult.StartedAt;
        studentName = spellingResult.Student.User.FullName;
        showCorrectAnswers = spellingResult.SpellingTest.ShowCorrectAnswers;
        testIcon = "fa-spell-check";
        testColor = "primary";
    }
    else if (isPunctuationResult)
    {
        testTitle = punctuationResult.PunctuationTest.Title;
        score = punctuationResult.Score;
        maxScore = punctuationResult.MaxScore;
        percentage = punctuationResult.Percentage;
        completedAt = punctuationResult.CompletedAt;
        startedAt = punctuationResult.StartedAt;
        studentName = punctuationResult.Student.User.FullName;
        showCorrectAnswers = punctuationResult.PunctuationTest.ShowCorrectAnswers;
        testIcon = "fa-quote-right";
        testColor = "danger";
    }
    else if (isOrthoeopyResult)
    {
        testTitle = orthoeopyResult.OrthoeopyTest.Title;
        score = orthoeopyResult.Score;
        maxScore = orthoeopyResult.MaxScore;
        percentage = orthoeopyResult.Percentage;
        completedAt = orthoeopyResult.CompletedAt;
        startedAt = orthoeopyResult.StartedAt;
        studentName = orthoeopyResult.Student.User.FullName;
        showCorrectAnswers = orthoeopyResult.OrthoeopyTest.ShowCorrectAnswers;
        testIcon = "fa-volume-up";
        testColor = "warning";
    }
    else if (isRegularResult)
    {
        testTitle = regularResult.RegularTest.Title;
        score = regularResult.Score;
        maxScore = regularResult.MaxScore;
        percentage = regularResult.Percentage;
        completedAt = regularResult.CompletedAt;
        startedAt = regularResult.StartedAt;
        studentName = regularResult.Student.User.FullName;
        showCorrectAnswers = regularResult.RegularTest.ShowCorrectAnswers;
        testIcon = "fa-list-ul";
        testColor = "success";
    }

    if (completedAt.HasValue)
    {
        duration = completedAt.Value - startedAt;
    }

    var gradeColor = percentage >= 80 ? "success" :
                     percentage >= 60 ? "warning" :
                     percentage >= 40 ? "info" : "danger";

    var grade = percentage >= 91 ? 5 :
                percentage >= 76 ? 4 :
                percentage >= 61 ? 3 : 2;
}


@if (ViewBag.IsModal != true)
{
    <div class="mb-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-compact">
                <li class="breadcrumb-item">
                    <a asp-action="Index">Мои тесты</a>
                </li>
                <li class="breadcrumb-item active text-truncate">@testTitle</li>
            </ol>
        </nav>
    </div>
}

<div class="test-container">
    
    
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-@testColor text-white py-2">
            <div class="d-flex justify-content-between align-items-center gap-2">
                <div class="flex-grow-1 min-w-0">
                    <h6 class="mb-0 d-flex align-items-center">
                        <i class="fas @testIcon me-2 flex-shrink-0"></i>
                        <span class="text-truncate">@testTitle</span>
                    </h6>
                </div>
                <div class="flex-shrink-0">
                    <span class="badge bg-@gradeColor fs-6">
                        Оценка: @grade
                    </span>
                </div>
            </div>
        </div>
    </div>

    
    <div class="card shadow-sm mb-3">
        <div class="card-body p-3">
            
            <div class="text-center mb-3">
                <div class="result-circle mx-auto" style="width: 120px; height: 120px;">
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#e9ecef" stroke-width="8" />
                        <circle cx="50" cy="50" r="45" fill="none"
                                stroke="@(percentage >= 80 ? "#28a745" : percentage >= 60 ? "#ffc107" : percentage >= 40 ? "#17a2b8" : "#dc3545")"
                                stroke-width="8"
                                stroke-dasharray="@(percentage * 2.827), 282.7"
                                transform="rotate(-90 50 50)" />
                        <text x="50" y="50" text-anchor="middle" dy="7"
                              font-size="20" font-weight="bold"
                              fill="@(percentage >= 80 ? "#28a745" : percentage >= 60 ? "#ffc107" : percentage >= 40 ? "#17a2b8" : "#dc3545")">
                            @percentage.ToString("F1")%
                        </text>
                    </svg>
                </div>
                <div class="mt-2">
                    <h5 class="mb-0 text-@gradeColor">@score / @maxScore баллов</h5>
                </div>
            </div>

            
            <div class="row text-center g-2">
                <div class="col-4">
                    <div class="p-2 bg-light rounded">
                        <i class="fas fa-user-graduate text-muted"></i>
                        <div class="mt-1">
                            <small class="fw-bold d-block text-truncate" style="font-size: 0.75rem;">@studentName</small>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 bg-light rounded">
                        <i class="fas fa-calendar text-muted"></i>
                        <div class="mt-1">
                            <small class="fw-bold d-block" style="font-size: 0.75rem;">@completedAt?.ToString("dd.MM.yyyy HH:mm")</small>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 bg-light rounded">
                        <i class="fas fa-stopwatch text-muted"></i>
                        <div class="mt-1">
                            <small class="fw-bold d-block" style="font-size: 0.75rem;">@($"{duration.Minutes:D2}:{duration.Seconds:D2}")</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    @if (showCorrectAnswers)
    {
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-light py-2">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h6 class="mb-0">
                        <i class="fas fa-list-alt"></i> Детальные результаты
                    </h6>
                    
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="showErrorsOnly" checked>
                        <label class="form-check-label small" for="showErrorsOnly">
                            Только ошибки
                        </label>
                    </div>
                </div>
            </div>
            <div class="card-body p-2 p-md-3">
                @if (isSpellingResult)
                {
                    @foreach (var question in spellingResult.SpellingTest.SpellingQuestions.OrderBy(q => q.OrderIndex))
                    {
                        var answer = spellingResult.SpellingAnswers.FirstOrDefault(a => a.SpellingQuestionId == question.Id);
                        var isCorrect = answer?.IsCorrect ?? false;
                        var questionIndex = spellingResult.SpellingTest.SpellingQuestions.OrderBy(q => q.OrderIndex).ToList().IndexOf(question) + 1;

                        <div class="question-result mb-2 p-2 border rounded @(isCorrect ? "border-success" : "border-danger")" 
                             data-correct="@isCorrect.ToString().ToLower()">
                            <div class="d-flex align-items-start gap-2">
                                
                                <div class="flex-shrink-0">
                                    <span class="badge bg-@(isCorrect ? "success" : "danger")">@questionIndex</span>
                                </div>
                                
                                
                                <div class="flex-grow-1 min-w-0">
                                    <div class="mb-2">
                                        <span class="word-with-gap" style="font-size: 1.1rem; padding: 6px 12px;">
                                            @question.WordWithGap
                                        </span>
                                    </div>
                                    
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted d-block">Ваш ответ:</small>
                                            <div class="fw-bold text-@(isCorrect ? "success" : "danger") small">
                                                @if (!string.IsNullOrEmpty(answer?.StudentAnswer))
                                                {
                                                    <span>"@answer.StudentAnswer"</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Не отвечено</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">Правильный:</small>
                                            <div class="fw-bold text-success small">
                                                "@question.CorrectLetter"
                                            </div>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(question.Hint))
                                    {
                                        <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                                            <small class="d-block">
                                                <i class="fas fa-lightbulb text-info"></i>
                                                <span class="text-muted">@question.Hint</span>
                                            </small>
                                        </div>
                                    }
                                </div>
                                
                                
                                <div class="flex-shrink-0 text-center">
                                    @if (isCorrect)
                                    {
                                        <i class="fas fa-check-circle text-success fa-2x"></i>
                                        <div class="mt-1">
                                            <small class="badge bg-success">@question.Points</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <i class="fas fa-times-circle text-danger fa-2x"></i>
                                        <div class="mt-1">
                                            <small class="badge bg-danger">0</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
                else if (isPunctuationResult)
                {
                    @foreach (var question in punctuationResult.PunctuationTest.PunctuationQuestions.OrderBy(q => q.OrderIndex))
                    {
                        var answer = punctuationResult.PunctuationAnswers.FirstOrDefault(a => a.PunctuationQuestionId == question.Id);
                        var isCorrect = answer?.IsCorrect ?? false;
                        var questionIndex = punctuationResult.PunctuationTest.PunctuationQuestions.OrderBy(q => q.OrderIndex).ToList().IndexOf(question) + 1;

                        <div class="question-result mb-2 p-2 border rounded @(isCorrect ? "border-success" : "border-danger")"
                             data-correct="@isCorrect.ToString().ToLower()">
                            <div class="d-flex align-items-start gap-2">
                                <div class="flex-shrink-0">
                                    <span class="badge bg-@(isCorrect ? "success" : "danger")">@questionIndex</span>
                                </div>
                                
                                <div class="flex-grow-1 min-w-0">
                                    <div class="mb-2 p-2 bg-light rounded">
                                        <small class="d-block">@question.SentenceWithNumbers</small>
                                    </div>
                                    
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted d-block">Ваш ответ:</small>
                                            <div class="fw-bold text-@(isCorrect ? "success" : "danger") small">
                                                @if (!string.IsNullOrEmpty(answer?.StudentAnswer))
                                                {
                                                    <span>@answer.StudentAnswer</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Не отвечено</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">Правильный:</small>
                                            <div class="fw-bold text-success small">
                                                @if (!string.IsNullOrEmpty(question.CorrectPositions))
                                                {
                                                    <span>@question.CorrectPositions</span>
                                                }
                                                else
                                                {
                                                    <span>Без запятых</span>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(question.PlainSentence))
                                    {
                                        <div class="mt-2 p-2 bg-success bg-opacity-10 rounded border-start border-success border-2">
                                            <small class="d-block text-muted">Правильный вариант:</small>
                                            <small class="fw-bold d-block">@question.PlainSentence</small>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(question.Hint))
                                    {
                                        <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                                            <small class="d-block">
                                                <i class="fas fa-lightbulb text-info"></i>
                                                <span class="text-muted">@question.Hint</span>
                                            </small>
                                        </div>
                                    }
                                </div>
                                
                                <div class="flex-shrink-0 text-center">
                                    @if (isCorrect)
                                    {
                                        <i class="fas fa-check-circle text-success fa-2x"></i>
                                        <div class="mt-1">
                                            <small class="badge bg-success">+@question.Points</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <i class="fas fa-times-circle text-danger fa-2x"></i>
                                        <div class="mt-1">
                                            <small class="badge bg-danger">0</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
                else if (isOrthoeopyResult)
                {
                    @foreach (var question in orthoeopyResult.OrthoeopyTest.OrthoeopyQuestions.OrderBy(q => q.OrderIndex))
                    {
                        var answer = orthoeopyResult.OrthoeopyAnswers.FirstOrDefault(a => a.OrthoeopyQuestionId == question.Id);
                        var isCorrect = answer?.IsCorrect ?? false;
                        var questionIndex = orthoeopyResult.OrthoeopyTest.OrthoeopyQuestions.OrderBy(q => q.OrderIndex).ToList().IndexOf(question) + 1;

                        <div class="question-result mb-2 p-2 border rounded @(isCorrect ? "border-success" : "border-danger")"
                             data-correct="@isCorrect.ToString().ToLower()">
                            <div class="d-flex align-items-start gap-2">
                                <div class="flex-shrink-0">
                                    <span class="badge bg-@(isCorrect ? "success" : "danger")">@questionIndex</span>
                                </div>
                                
                                <div class="flex-grow-1 min-w-0">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Слово:</small>
                                        <span class="h6 mb-0">@question.Word</span>
                                    </div>
                                    
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted d-block">Ваш ответ:</small>
                                            <div class="fw-bold text-@(isCorrect ? "success" : "danger") small">
                                                @if (answer?.SelectedStressPosition.HasValue == true)
                                                {
                                                    <span>@answer.SelectedStressPosition слог</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Не отвечено</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">Правильный:</small>
                                            <div class="fw-bold text-success">
                                                <span class="h6 mb-0">@question.WordWithStress</span>
                                                <small class="d-block text-muted">(@question.StressPosition слог)</small>
                                            </div>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(question.Hint))
                                    {
                                        <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                                            <small class="d-block">
                                                <i class="fas fa-lightbulb text-info"></i>
                                                <span class="text-muted">@question.Hint</span>
                                            </small>
                                        </div>
                                    }
                                </div>
                                
                                <div class="flex-shrink-0 text-center">
                                    @if (isCorrect)
                                    {
                                        <i class="fas fa-check-circle text-success fa-2x"></i>
                                        <div class="mt-1">
                                            <small class="badge bg-success">+@question.Points</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <i class="fas fa-times-circle text-danger fa-2x"></i>
                                        <div class="mt-1">
                                            <small class="badge bg-danger">0</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
                else if (isRegularResult)
                {
                    @for (int i = 0; i < regularResult.RegularTest.RegularQuestions.Count; i++)
                    {
                        var question = regularResult.RegularTest.RegularQuestions.OrderBy(q => q.OrderIndex).ElementAt(i);
                        var answer = regularResult.RegularAnswers.FirstOrDefault(a => a.QuestionId == question.Id);
                        var isAnswered = answer != null;
                        var isCorrect = answer?.IsCorrect ?? false;

                        var selectedIds = new List<int>();
                        if (!string.IsNullOrEmpty(answer?.SelectedOptionIds))
                        {
                            selectedIds = answer.SelectedOptionIds.Split(',', StringSplitOptions.RemoveEmptyEntries)
                            .Select(id => int.Parse(id.Trim())).ToList();
                        }

                        <div class="question-result mb-2 border rounded @(isAnswered ? (isCorrect ? "border-success" : "border-danger") : "border-secondary")"
                             data-correct="@isCorrect.ToString().ToLower()">
                            <div class="accordion" id="accordion@i">
                                <div class="accordion-item border-0">
                                    <h2 class="accordion-header" id="heading@i">
                                        <button class="accordion-button @(i > 0 ? "collapsed" : "") p-2" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapse@i">
                                            <div class="w-100 d-flex justify-content-between align-items-center gap-2">
                                                <div class="d-flex align-items-center gap-2 flex-grow-1 min-w-0">
                                                    <span class="badge bg-@(isAnswered ? (isCorrect ? "success" : "danger") : "secondary")">@(i + 1)</span>
                                                    <span class="badge bg-@(question.Type == QuestionType.SingleChoice ? "primary" : question.Type == QuestionType.MultipleChoice ? "success" : "warning") badge-sm">
                                                        <i class="fas @question.Type.GetIcon()"></i>
                                                    </span>
                                                    <span class="small text-truncate">@question.Text</span>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    @if (isAnswered)
                                                    {
                                                        @if (isCorrect)
                                                        {
                                                            <span class="badge bg-success badge-sm">
                                                                <i class="fas fa-check"></i> +@answer.Points
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-danger badge-sm">
                                                                <i class="fas fa-times"></i> 0
                                                            </span>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary badge-sm">—</span>
                                                    }
                                                </div>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapse@i" class="accordion-collapse collapse @(i == 0 ? "show" : "")"
                                         data-bs-parent="#accordion@i">
                                        <div class="accordion-body p-2">
                                            @if (!string.IsNullOrEmpty(question.Hint))
                                            {
                                                <div class="alert alert-info alert-sm py-2 mb-2">
                                                    <small>
                                                        <i class="fas fa-lightbulb"></i>
                                                        <strong>Подсказка:</strong> @question.Hint
                                                    </small>
                                                </div>
                                            }

                                            <div class="mb-2">
                                                @foreach (var option in question.Options.OrderBy(o => o.OrderIndex))
                                                {
                                                    var isSelected = selectedIds.Contains(option.Id);
                                                    var cardClass = "";
                                                    var borderClass = "";

                                                    if (option.IsCorrect)
                                                    {
                                                        cardClass = "bg-success bg-opacity-10";
                                                        borderClass = "border-success";
                                                    }
                                                    else if (isSelected)
                                                    {
                                                        cardClass = "bg-danger bg-opacity-10";
                                                        borderClass = "border-danger";
                                                    }

                                                    <div class="card mb-1 @cardClass @borderClass border">
                                                        <div class="card-body p-2">
                                                            <div class="d-flex justify-content-between align-items-start gap-2">
                                                                <div class="flex-grow-1">
                                                                    <small>
                                                                        @if (question.Type == QuestionType.MultipleChoice)
                                                                        {
                                                                            @if (isSelected)
                                                                            {
                                                                                <i class="fas fa-check-square text-primary me-1"></i>
                                                                            }
                                                                            else
                                                                            {
                                                                                <i class="far fa-square text-muted me-1"></i>
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                            @if (isSelected)
                                                                            {
                                                                                <i class="fas fa-dot-circle text-primary me-1"></i>
                                                                            }
                                                                            else
                                                                            {
                                                                                <i class="far fa-circle text-muted me-1"></i>
                                                                            }
                                                                        }
                                                                        @option.Text
                                                                    </small>
                                                                </div>
                                                                <div class="flex-shrink-0">
                                                                    @if (option.IsCorrect)
                                                                    {
                                                                        <span class="badge bg-success badge-sm">
                                                                            <i class="fas fa-check"></i>
                                                                        </span>
                                                                    }
                                                                    @if (isSelected && !option.IsCorrect)
                                                                    {
                                                                        <span class="badge bg-danger badge-sm">
                                                                            <i class="fas fa-times"></i>
                                                                        </span>
                                                                    }
                                                                </div>
                                                            </div>

                                                            @if (!string.IsNullOrEmpty(option.Explanation))
                                                            {
                                                                <small class="text-muted d-block mt-1">
                                                                    <i class="fas fa-info-circle"></i> @option.Explanation
                                                                </small>
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                            </div>

                                            @if (!string.IsNullOrEmpty(question.Explanation))
                                            {
                                                <div class="alert alert-success alert-sm py-2 mb-0">
                                                    <small>
                                                        <i class="fas fa-graduation-cap"></i>
                                                        <strong>Объяснение:</strong> @question.Explanation
                                                    </small>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }
    else
    {
        <div class="card shadow-sm mb-3">
            <div class="card-body p-3 text-center">
                <i class="fas fa-eye-slash fa-2x text-muted mb-2"></i>
                <h6 class="mb-1">Детальные результаты скрыты</h6>
                <small class="text-muted">Учитель отключил показ правильных ответов для этого теста</small>
            </div>
        </div>
    }

    @if (ViewBag.IsModal != true)
    {
        <div class="card shadow-sm navigation-card">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
                    <a asp-action="Index" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-left"></i>
                        <span class="d-none d-sm-inline ms-1">К списку тестов</span>
                    </a>
                    <a asp-action="History" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-history"></i>
                        <span class="d-none d-sm-inline ms-1">История</span>
                    </a>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Анимация круговой диаграммы
        document.addEventListener('DOMContentLoaded', function() {
            const circle = document.querySelector('.result-circle circle:nth-child(2)');
            if (circle) {
                circle.style.transition = 'stroke-dasharray 1s ease';
            }

            // Фильтр "Только ошибки"
            const filterCheckbox = document.getElementById('showErrorsOnly');
            if (filterCheckbox) {
                // Функция фильтрации
                function applyFilter() {
                    const questions = document.querySelectorAll('.question-result');
                    
                    questions.forEach(function(question) {
                        const isCorrect = question.getAttribute('data-correct') === 'true';
                        
                        if (filterCheckbox.checked) {
                            // Показывать только неправильные
                            if (isCorrect) {
                                question.style.display = 'none';
                            } else {
                                question.style.display = 'block';
                            }
                        } else {
                            // Показывать все
                            question.style.display = 'block';
                        }
                    });
                }

                // Обработчик изменения чекбокса
                filterCheckbox.addEventListener('change', applyFilter);

                // Применить фильтр сразу при загрузке (если чекбокс включен)
                applyFilter();
            }
        });
    </script>
}

