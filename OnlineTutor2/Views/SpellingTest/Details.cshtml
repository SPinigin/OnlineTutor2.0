@model OnlineTutor2.Models.SpellingTest
@{
    ViewData["Title"] = $"Тест: {Model.Title}";
}

<div class="container-fluid px-2 px-md-3">
    <div class="mb-3">
    
        <div class="d-flex justify-content-between align-items-center mb-2">
            <nav aria-label="breadcrumb" class="flex-grow-1">
                <ol class="breadcrumb breadcrumb-compact mb-0">
                    <li class="breadcrumb-item">
                        <a asp-controller="Test" asp-action="Category" asp-route-id="@TestCategoryConstants.Spelling">Орфография</a>
                    </li>
                    <li class="breadcrumb-item active">@Model.Title</li>
                </ol>
            </nav>
            <div class="flex-shrink-0 ms-2">
                <a asp-controller="Test" asp-action="Category" asp-route-id="@TestCategoryConstants.Spelling" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Назад</span>
                </a>
            </div>
        </div>
    
    
        <h4 class="mb-1 d-flex align-items-center gap-2 flex-wrap">
            <i class="fas fa-spell-check text-primary"></i>
            <span>@Model.Title</span>
            <span class="badge bg-@(Model.IsActive ? "success" : "secondary") status-badge-compact"
                  title="@(Model.IsActive ? "Активный" : "Неактивный")">
                <i class="fas fa-@(Model.IsActive ? "check-circle" : "times-circle")"></i>
            </span>
        </h4>
    
    
        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <p class="text-muted mb-0 small">@Model.Description</p>
        }
    </div>
    

    <div class="row mb-3 g-2">
        <div class="col-6 col-md-3">
            <div class="card text-center border-primary stats-card-compact">
                <div class="card-body text-center py-2 px-1">
                    <i class="fas fa-question-circle text-primary mb-1"></i>
                    <h5 class="mb-0 text-primary fw-bold">@Model.SpellingQuestions.Count</h5>
                    <small class="text-muted d-block">Вопросов</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-info stats-card-compact">
                <div class="card-body text-center py-2 px-1">
                    <i class="fas fa-clock text-info mb-1"></i>
                    <h5 class="mb-0 text-info fw-bold">@Model.TimeLimit</h5>
                    <small class="text-muted d-block">Минут</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-warning stats-card-compact">
                <div class="card-body text-center py-2 px-1">
                    <i class="fas fa-redo text-warning mb-1"></i>
                    <h5 class="mb-0 text-warning fw-bold">@Model.MaxAttempts</h5>
                    <small class="text-muted d-block">Попыток</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-success stats-card-compact">
                <div class="card-body text-center py-2 px-1">
                    <i class="fas fa-users text-success mb-1"></i>
                    <h5 class="mb-0 text-success fw-bold">@Model.SpellingTestResults.Count</h5>
                    <small class="text-muted d-block">Результатов</small>
                </div>
            </div>
        </div>
    </div>


    <div class="settings-bar mb-3">
        <div class="d-flex flex-wrap align-items-center gap-2 settings-inline">
            <div class="setting-label-main">
                <i class="fas fa-cog text-primary me-1"></i>
                <strong>Настройки:</strong>
            </div>
        
            @if (Model.TestClasses.Any())
            {
                <div class="d-flex flex-wrap gap-1">
                    @foreach (var testClass in Model.TestClasses)
                    {
                        <span class="badge bg-info">@testClass.Class.Name</span>
                    }
                </div>
            }
            else
            {
                <span class="text-muted">Доступен всем ученикам</span>
            }
        
            <div class="setting-chip">
                <i class="fas fa-lightbulb text-muted me-1"></i>
                <span class="badge bg-@(Model.ShowHints ? "success" : "secondary") badge-sm">
                    Подсказки: @(Model.ShowHints ? "Вкл" : "Выкл")
                </span>
            </div>
        
            <span class="setting-divider">|</span>
        
            <div class="setting-chip">
                <i class="fas fa-eye text-muted me-1"></i>
                <span class="badge bg-@(Model.ShowCorrectAnswers ? "success" : "secondary") badge-sm">
                    Ответы: @(Model.ShowCorrectAnswers ? "Вкл" : "Выкл")
                </span>
            </div>
        
            @if (Model.StartDate.HasValue || Model.EndDate.HasValue)
            {
                <span class="setting-divider d-none d-lg-inline">|</span>
                <div class="setting-chip d-none d-lg-flex">
                    <i class="fas fa-calendar text-muted me-1"></i>
                    <span class="text-muted small">
                        @if (Model.StartDate.HasValue)
                        {
                            @Model.StartDate.Value.ToString("dd.MM.yyyy")
                        }
                        @if (Model.StartDate.HasValue && Model.EndDate.HasValue)
                        {
                            <span> - </span>
                        }
                        @if (Model.EndDate.HasValue)
                        {
                            @Model.EndDate.Value.ToString("dd.MM.yyyy")
                        }
                    </span>
                </div>
            }
        </div>
    </div>


    <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-white border-0 py-2 px-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            
                <button class="btn btn-outline-primary btn-sm d-flex align-items-center gap-2"
                        id="toggleQuestionsBtn"
                        onclick="toggleQuestions()">
                    <span id="toggleText">Показать вопросы (@Model.SpellingQuestions.Count)</span>
                    <i class="fas fa-chevron-down" id="toggleIcon"></i>
                </button>

            
                <div class="d-flex gap-2">
                    <a asp-action="AddQuestion" asp-route-id="@Model.Id"
                       class="btn btn-success btn-sm btn-icon"
                       title="Добавить вопрос">
                        <i class="fas fa-plus"></i>
                    </a>
                    <a asp-action="ImportQuestions" asp-route-id="@Model.Id"
                       class="btn btn-info btn-sm btn-icon"
                       title="Импорт вопросов">
                        <i class="fas fa-file-import"></i>
                    </a>
                    <a asp-controller="TestAnalytics" asp-action="Spelling" asp-route-id="@Model.Id"
                       class="btn btn-secondary btn-sm btn-icon"
                       title="Аналитика">
                        <i class="fas fa-chart-bar"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="card-body p-0" id="questionsContainer" style="display: none;">
            @if (Model.SpellingQuestions.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover table-compact mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" style="width: 40px;">#</th>
                                <th>Вопрос</th>
                                <th class="text-center" style="width: 80px;">Ответ</th>
                                <th class="d-none d-lg-table-cell">Слово</th>
                                <th class="text-center d-none d-md-table-cell" style="width: 70px;">Баллы</th>
                                <th class="text-center" style="width: 120px;">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var question in Model.SpellingQuestions.OrderBy(q => q.OrderIndex))
                            {
                                <tr class="question-row clickable-row"
                                    data-question-id="@question.Id"
                                    data-word-gap="@question.WordWithGap"
                                    data-correct-letter="@question.CorrectLetter"
                                    data-full-word="@question.FullWord"
                                    data-hint="@(question.Hint ?? "")"
                                    data-points="@question.Points">
                                    <td class="text-center">
                                        <span class="badge bg-primary badge-sm">@question.OrderIndex</span>
                                    </td>
                                    <td class="fw-semibold text-primary">@question.WordWithGap</td>
                                    <td class="text-center">
                                        <span class="badge bg-success badge-sm">@question.CorrectLetter</span>
                                    </td>
                                    <td class="d-none d-lg-table-cell">@question.FullWord</td>
                                    <td class="text-center d-none d-md-table-cell">
                                        <span class="badge bg-info badge-sm">@question.Points</span>
                                    </td>
                                    <td class="actions-cell">
                                        <div class="d-flex justify-content-center gap-1">
                                    
                                            <button type="button" class="btn btn-outline-info btn-sm btn-icon btn-view d-none d-md-inline-flex"
                                                    data-question-id="@question.Id"
                                                    title="Просмотр">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                    
                                            <button type="button" class="btn btn-outline-primary btn-sm btn-icon btn-edit"
                                                    data-question-id="@question.Id"
                                                    title="Редактировать">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                    
                                            <button type="button" class="btn btn-outline-danger btn-sm btn-icon btn-delete"
                                                    data-question-id="@question.Id"
                                                    data-word-gap="@question.WordWithGap"
                                                    title="Удалить">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4 px-3">
                    <i class="fas fa-question-circle text-muted mb-3" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mb-2">Вопросов пока нет</h5>
                    <p class="text-muted small mb-3">Добавьте первый вопрос в тест</p>
                    <div class="d-flex justify-content-center gap-2 flex-wrap">
                        <a asp-action="AddQuestion" asp-route-id="@Model.Id" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> Добавить вопрос
                        </a>
                        <a asp-action="ImportQuestions" asp-route-id="@Model.Id" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-import"></i> Импорт из Excel
                        </a>
                    </div>
                </div>
            }
        </div>


    </div>

    
    @if (Model.SpellingTestResults.Any())
    {
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light py-2 px-3">
                <h6 class="mb-0 fw-semibold">
                    <i class="fas fa-chart-line text-primary"></i> Последние прохождения
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-compact mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Ученик</th>
                                <th class="d-none d-md-table-cell">Дата</th>
                                <th class="text-center">Результат</th>
                                <th class="text-center d-none d-sm-table-cell">Статус</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var result in Model.SpellingTestResults.OrderByDescending(tr => tr.StartedAt).Take(5))
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span>@result.Student.User.FullName</span>
                                            <small class="text-muted d-md-none">@result.StartedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        @result.StartedAt.ToString("dd.MM.yyyy HH:mm")
                                    </td>
                                    <td class="text-center">
                                        @if (result.IsCompleted)
                                        {
                                            var grade = GetGradeFromPercentage(result.Percentage);
                                            var gradeColor = GetGradeColor(grade);

                                            <div class="d-flex flex-column align-items-center gap-1">
                                                <div class="d-flex align-items-center gap-1">
                                                    <span class="badge bg-@(result.Percentage >= 80 ? "success" : result.Percentage >= 60 ? "warning" : "danger") badge-sm">
                                                        @result.Percentage.ToString("F1")%
                                                    </span>
                                                    <span class="grade-badge-compact grade-@gradeColor">
                                                        @grade
                                                    </span>
                                                </div>
                                                <small class="text-muted">@result.Score/@result.MaxScore</small>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-center d-none d-sm-table-cell">
                                        @if (result.IsCompleted)
                                        {
                                            <span class="badge bg-success badge-sm">
                                                <i class="fas fa-check-circle"></i> Завершен
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning badge-sm">
                                                <i class="fas fa-clock"></i> В процессе
                                            </span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @if (Model.SpellingTestResults.Count > 0)
                {
                    <div class="text-center p-2 border-top">
                        <a asp-controller="TestAnalytics" asp-action="Spelling" asp-route-id="@Model.Id" 
                           class="btn btn-outline-info btn-sm">
                            <i class="fas fa-chart-bar"></i> Вся аналитика
                        </a>
                    </div>
                }
            </div>
        </div>
    }
</div>


<div class="modal fade" id="questionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title mb-0">
                    <i class="fas fa-question-circle text-primary"></i> Детали вопроса
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body py-3">
                <div class="mb-2">
                    <label class="form-label small fw-semibold mb-1">Слово с пропуском:</label>
                    <div class="p-2 bg-light rounded">
                        <span class="h6 text-primary mb-0" id="modalWordWithGap"></span>
                    </div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="form-label small fw-semibold mb-1">Правильная буква:</label>
                        <div class="p-2 bg-success text-white rounded text-center">
                            <span class="fw-bold" id="modalCorrectLetter"></span>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-semibold mb-1">Полное слово:</label>
                        <div class="p-2 bg-info text-white rounded text-center">
                            <span class="fw-bold" id="modalFullWord"></span>
                        </div>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label small fw-semibold mb-1">Подсказка:</label>
                    <div class="p-2 bg-light rounded">
                        <span class="small" id="modalHint"></span>
                    </div>
                </div>
                <div>
                    <label class="form-label small fw-semibold mb-1">Баллы:</label>
                    <span class="badge bg-warning" id="modalPoints"></span>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="editQuestionFromModal()">
                    <i class="fas fa-edit"></i> Редактировать
                </button>
            </div>
        </div>
    </div>
</div>

@functions {
    int GetGradeFromPercentage(double percentage)
    {
        if (percentage >= 91) return 5;
        if (percentage >= 76) return 4;
        if (percentage >= 61) return 3;
        return 2;
    }

    string GetGradeColor(int grade)
    {
        return grade switch
        {
            5 => "excellent",
            4 => "good",
            3 => "satisfactory",
            2 => "unsatisfactory",
            _ => "unsatisfactory"
        };
    }
}

@section Scripts {
    <script src="~/js/layout.js" asp-append-version="true"></script>
    <script>
        let currentQuestionId = null;
        let questionsVisible = false;

        function toggleQuestions() {
            const container = document.getElementById('questionsContainer');
            const icon = document.getElementById('toggleIcon');
            const text = document.getElementById('toggleText');
            
            questionsVisible = !questionsVisible;
            
            if (questionsVisible) {
                container.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                text.textContent = 'Скрыть вопросы (@Model.SpellingQuestions.Count)';
            } else {
                container.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                text.textContent = 'Показать вопросы (@Model.SpellingQuestions.Count)';
            }
        }

        // Инициализация обработчиков событий
        document.addEventListener('DOMContentLoaded', function() {
            initializeQuestionRowHandlers();
        });

        function initializeQuestionRowHandlers() {
            // Обработчик клика на строки вопросов
            document.querySelectorAll('.question-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    // Проверяем, что клик не был по кнопкам или колонке с действиями
                    if (e.target.closest('.actions-cell') || e.target.closest('button')) {
                        return;
                    }
                    
                    const id = this.dataset.questionId;
                    const wordGap = this.dataset.wordGap;
                    const correctLetter = this.dataset.correctLetter;
                    const fullWord = this.dataset.fullWord;
                    const hint = this.dataset.hint;
                    const points = this.dataset.points;
                    
                    openQuestionModal(id, wordGap, correctLetter, fullWord, hint, points);
                });
            });

            // Обработчики для кнопок просмотра
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const row = this.closest('tr');
                    const id = row.dataset.questionId;
                    const wordGap = row.dataset.wordGap;
                    const correctLetter = row.dataset.correctLetter;
                    const fullWord = row.dataset.fullWord;
                    const hint = row.dataset.hint;
                    const points = row.dataset.points;
                    
                    openQuestionModal(id, wordGap, correctLetter, fullWord, hint, points);
                });
            });

            // Обработчики для кнопок редактирования
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const questionId = this.dataset.questionId;
                    editQuestion(questionId);
                });
            });

            // Обработчики для кнопок удаления
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const questionId = this.dataset.questionId;
                    const wordGap = this.dataset.wordGap;
                    deleteQuestion(questionId, wordGap);
                });
            });
        }

        function openQuestionModal(id, wordGap, correctLetter, fullWord, hint, points) {
            showQuestionDetails(id, wordGap, correctLetter, fullWord, hint, points);
            const modalElement = document.getElementById('questionModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        function showQuestionDetails(id, wordGap, correctLetter, fullWord, hint, points) {
            currentQuestionId = id;
            
            document.getElementById('modalWordWithGap').textContent = wordGap;
            document.getElementById('modalCorrectLetter').textContent = correctLetter;
            document.getElementById('modalFullWord').textContent = fullWord;
            document.getElementById('modalHint').textContent = hint || 'Подсказка не указана';
            document.getElementById('modalPoints').textContent = points;
        }

        function editQuestion(questionId) {
            window.location.href = '@Url.Action("EditQuestion")?id=' + questionId;
        }

        function editQuestionFromModal() {
            if (currentQuestionId) {
                window.location.href = '@Url.Action("EditQuestion")?id=' + currentQuestionId;
            }
        }

        function deleteQuestion(questionId, wordWithGap) {
            if (confirm(`Вы уверены, что хотите удалить вопрос "${wordWithGap}"?\n\nВнимание: Если на этот вопрос уже отвечали ученики, удаление будет невозможно.`)) {
                fetch('@Url.Action("DeleteQuestion")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(parseInt(questionId))
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Произошла ошибка при удалении вопроса', 'error');
                });
            }
        }

        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';

            const notification = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert" 
                     style="position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <i class="${icon} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', notification);

            setTimeout(() => {
                const alerts = document.querySelectorAll('.alert');
                if (alerts.length > 0) {
                    alerts[alerts.length - 1].remove();
                }
            }, 5000);
        }
    </script>
    @Html.AntiForgeryToken()
}
