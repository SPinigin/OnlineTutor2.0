@model OnlineTutor2.ViewModels.SpellingTestAnalyticsViewModel
@{
    ViewData["Title"] = $"Аналитика теста: {Model.SpellingTest.Title}";
}

<div class="container-fluid px-2 px-md-3">
    
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <nav aria-label="breadcrumb" class="flex-grow-1">
                <ol class="breadcrumb breadcrumb-compact mb-0">
                    <li class="breadcrumb-item">
                        <a asp-controller="Test" asp-action="Category" asp-route-id="@TestCategoryConstants.Spelling">Орфография</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-controller="SpellingTest" asp-action="Details" asp-route-id="@Model.SpellingTest.Id">@Model.SpellingTest.Title</a>
                    </li>
                    <li class="breadcrumb-item active">Аналитика</li>
                </ol>
            </nav>
            <div class="flex-shrink-0 ms-2 d-flex align-items-center gap-2">
                <a asp-controller="SpellingTest" asp-action="Details" asp-route-id="@Model.SpellingTest.Id" 
                   class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Назад</span>
                </a>
            </div>
        </div>
        
        <h4 class="mb-0 d-flex align-items-center gap-2">
            <i class="fas fa-chart-bar text-primary"></i>
            <span>Аналитика</span>
        </h4>
    </div>

    
    <div class="row mb-3 g-2">
        <div class="col-6 col-sm-4 col-md-2">
            <div class="card text-center border-primary stats-card-compact">
                <div class="card-body p-2">
                    <i class="fas fa-users text-primary fs-5"></i>
                    <h5 class="mt-1 mb-0 text-primary">@Model.Statistics.TotalStudents</h5>
                    <small class="text-muted d-block" style="font-size: 0.7rem;">Учеников</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-2">
            <div class="card text-center border-info stats-card-compact">
                <div class="card-body p-2">
                    <i class="fas fa-percentage text-info fs-5"></i>
                    <h5 class="mt-1 mb-0 text-info">@Model.Statistics.AveragePercentage.ToString("F1")%</h5>
                    <small class="text-muted d-block" style="font-size: 0.7rem;">Ср. результат</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-2">
            <div class="card text-center border-secondary stats-card-compact">
                <div class="card-body p-2">
                    <i class="fas fa-stopwatch text-secondary fs-5"></i>
                    <h5 class="mt-1 mb-0 text-secondary">@($"{Model.Statistics.AverageCompletionTime.Minutes:D2}:{Model.Statistics.AverageCompletionTime.Seconds:D2}")</h5>
                    <small class="text-muted d-block" style="font-size: 0.7rem;">Ср. время</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-2">
            <div class="card text-center border-success stats-card-compact">
                <div class="card-body p-2">
                    <i class="fas fa-check-circle text-success fs-5"></i>
                    <h5 class="mt-1 mb-0 text-success">@Model.Statistics.StudentsCompleted</h5>
                    <small class="text-muted d-block" style="font-size: 0.7rem;">Завершили</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-2">
            <div class="card text-center border-warning stats-card-compact">
                <div class="card-body p-2">
                    <i class="fas fa-clock text-warning fs-5"></i>
                    <h5 class="mt-1 mb-0 text-warning">@Model.Statistics.StudentsInProgress</h5>
                    <small class="text-muted d-block" style="font-size: 0.7rem;">В процессе</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-2">
            <div class="card text-center border-danger stats-card-compact">
                <div class="card-body p-2">
                    <i class="fas fa-times-circle text-danger fs-5"></i>
                    <h5 class="mt-1 mb-0 text-danger">@Model.Statistics.StudentsNotStarted</h5>
                    <small class="text-muted d-block" style="font-size: 0.7rem;">Не начали</small>
                </div>
            </div>
        </div>
    </div>

    
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body py-2 px-3">
            <div class="d-flex align-items-center flex-wrap gap-2 small">
                <div class="me-2">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Информация:</strong>
                </div>

                <div class="d-flex gap-2 flex-wrap">
                    <span><i class="fas fa-list text-info me-1"></i>@Model.SpellingTest.SpellingQuestions.Count</span>
                    <span><i class="fas fa-clock text-warning me-1"></i>@Model.SpellingTest.TimeLimit мин</span>
                    <span><i class="fas fa-redo text-secondary me-1"></i>@Model.SpellingTest.MaxAttempts</span>
                </div>

                <div class="d-flex gap-1">
                    <span class="badge @(Model.SpellingTest.ShowHints ? "bg-success" : "bg-secondary") badge-sm">
                        <i class="fas fa-lightbulb"></i>
                        <span class="d-none d-sm-inline ms-1">Подсказки</span>
                    </span>
                    <span class="badge @(Model.SpellingTest.ShowCorrectAnswers ? "bg-success" : "bg-secondary") badge-sm">
                        <i class="fas fa-check"></i>
                        <span class="d-none d-sm-inline ms-1">Ответы</span>
                    </span>
                </div>

                @if (Model.SpellingTest.StartDate.HasValue || Model.SpellingTest.EndDate.HasValue)
                {
                    <div class="d-none d-lg-flex gap-2 ms-auto">
                        @if (Model.SpellingTest.StartDate.HasValue)
                        {
                            <span><i class="fas fa-play text-success me-1"></i>@Model.SpellingTest.StartDate.Value.ToString("dd.MM HH:mm")</span>
                        }
                        @if (Model.SpellingTest.EndDate.HasValue)
                        {
                            <span><i class="fas fa-stop text-danger me-1"></i>@Model.SpellingTest.EndDate.Value.ToString("dd.MM HH:mm")</span>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    
    <ul class="nav nav-tabs" id="analyticsTabsNav" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
                <i class="fas fa-users"></i> <span class="d-none d-sm-inline">Результаты</span> <span class="d-sm-none">Результаты</span> (@Model.SpellingResults.Count)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab">
                <i class="fas fa-spell-check"></i> <span class="d-none d-sm-inline">Анализ</span> <span class="d-sm-none">Анализ</span> (@Model.SpellingQuestionAnalytics.Count)
            </button>
        </li>
    </ul>

    <div class="tab-content" id="analyticsTabsContent">
        
        
        <div class="tab-pane fade show active" id="students" role="tabpanel">
            <div class="card mt-3 border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-compact mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Ученик</th>
                                    <th class="text-center">Статус</th>
                                    <th class="text-center d-none d-md-table-cell">Попыток</th>
                                    <th class="text-center d-none d-md-table-cell">Лучший</th>
                                    <th class="text-center">Последний</th>
                                    <th class="text-center d-none d-lg-table-cell">Время</th>
                                    <th class="text-center">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var studentResult in Model.SpellingResults)
                                {
                                    <tr>
                                
                                        <td>
                                            <div class="d-flex flex-column">
                                                <strong class="student-name-mobile">@studentResult.Student.User.FullName</strong>
                                            </div>
                                        </td>
                                
                                
                                        <td class="text-center">
                                            @if (studentResult.HasCompleted)
                                            {
                                                <span class="badge bg-success badge-sm">
                                                    <i class="fas fa-check d-md-none"></i>
                                                    <span class="d-none d-md-inline">Завершил</span>
                                                </span>
                                            }
                                            else if (studentResult.IsInProgress)
                                            {
                                                <span class="badge bg-warning badge-sm">
                                                    <i class="fas fa-clock d-md-none"></i>
                                                    <span class="d-none d-md-inline">В процессе</span>
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger badge-sm">
                                                    <i class="fas fa-times d-md-none"></i>
                                                    <span class="d-none d-md-inline">Не начал</span>
                                                </span>
                                            }
                                        </td>
                                
                                
                                        <td class="text-center d-none d-md-table-cell">
                                            <span class="badge bg-info badge-sm">
                                                @studentResult.AttemptsUsed/@Model.SpellingTest.MaxAttempts
                                            </span>
                                        </td>
                                
                                
                                        <td class="text-center d-none d-md-table-cell">
                                            @if (studentResult.BestResult != null)
                                            {
                                                var bestGrade = GetGradeFromPercentage(studentResult.BestResult.Percentage);
                                                var bestGradeColor = GetGradeColor(bestGrade);

                                                <div class="d-flex flex-column align-items-center gap-1">
                                                    <div class="d-flex align-items-center gap-1">
                                                        <span class="badge bg-@(studentResult.BestResult.Percentage >= 80 ? "success" : studentResult.BestResult.Percentage >= 60 ? "warning" : "danger") badge-sm">
                                                            @studentResult.BestResult.Percentage.ToString("F1")%
                                                        </span>
                                                        <span class="grade-badge-compact grade-@bestGradeColor">
                                                            @bestGrade
                                                        </span>
                                                    </div>
                                                    <small class="text-muted">
                                                        @studentResult.BestResult.Score/@studentResult.BestResult.MaxScore
                                                    </small>
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                
                                
                                        <td class="text-center">
                                            @if (studentResult.LatestResult != null)
                                            {
                                                var latestGrade = GetGradeFromPercentage(studentResult.LatestResult.Percentage);
                                                var latestGradeColor = GetGradeColor(latestGrade);

                                                <div class="d-flex flex-column align-items-center gap-1">
                                                    <div class="d-flex align-items-center gap-1">
                                                        <span class="badge bg-@(studentResult.LatestResult.Percentage >= 80 ? "success" : studentResult.LatestResult.Percentage >= 60 ? "warning" : "danger") badge-sm">
                                                            @studentResult.LatestResult.Percentage.ToString("F1")%
                                                        </span>
                                                        <span class="grade-badge-compact grade-@latestGradeColor">
                                                            @latestGrade
                                                        </span>
                                                    </div>
                                                    <small class="text-muted d-none d-md-block">
                                                        @studentResult.LatestResult.Score/@studentResult.LatestResult.MaxScore
                                                    </small>
                                                    <small class="text-muted d-none d-lg-block">
                                                        @studentResult.LatestResult.CompletedAt?.ToString("dd.MM")
                                                    </small>
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                
                                
                                        <td class="text-center d-none d-lg-table-cell">
                                            @if (studentResult.TotalTimeSpent.HasValue)
                                            {
                                                <span>@($"{studentResult.TotalTimeSpent.Value.Minutes:D2}:{studentResult.TotalTimeSpent.Value.Seconds:D2}")</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                
                                
                                        <td class="text-center">
                                            @if (studentResult.Results.Any())
                                            {
                                                <button type="button" class="btn btn-outline-info btn-sm btn-icon"
                                                        onclick="showStudentDetails(@studentResult.Student.Id, '@studentResult.Student.User.FullName')"
                                                        title="Детали">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        
        
        <div class="tab-pane fade" id="questions" role="tabpanel">
            <div class="mt-3">
        
        
                <div class="card mb-3 border-0 shadow-sm">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-filter text-primary"></i>
                                <strong class="small">Фильтр:</strong>
                            </div>
                    
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                        
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input" type="checkbox" id="filterMistakesOnly" onchange="filterQuestions()">
                                    <label class="form-check-label small" for="filterMistakesOnly">
                                        Ошибки
                                    </label>
                                </div>
                        
                        
                                <div class="d-flex gap-2 small">
                                    <span class="badge bg-secondary" id="questionsCount">
                                        Всего: @Model.SpellingQuestionAnalytics.Count
                                    </span>
                                    <span class="badge bg-danger" id="mistakesCount">
                                        С ошибками: @Model.SpellingQuestionAnalytics.Count(q => q.CommonMistakes.Any())
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

        
                <div id="questionsListContainer">
                    @foreach (var qa in Model.SpellingQuestionAnalytics)
                    {
                        var questionIndex = Model.SpellingQuestionAnalytics.IndexOf(qa) + 1;
                        var hasMistakes = qa.CommonMistakes.Any();

                        <div class="card mb-3 border-0 shadow-sm question-analytics-card @(hasMistakes ? "has-mistakes" : "no-mistakes") @(qa.IsMostDifficult ? "border-start border-danger border-3" : qa.IsEasiest ? "border-start border-success border-3" : "")"
                             data-has-mistakes="@hasMistakes.ToString().ToLower()">
                     
                            <div class="card-header bg-transparent border-0 py-3">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="d-flex align-items-center gap-3">
                                            <span class="badge bg-primary fs-6 px-3 py-2">@questionIndex</span>
                                            <div>
                                                <h6 class="mb-1 fw-bold text-primary">@qa.SpellingQuestion.WordWithGap</h6>
                                                <small class="text-muted">
                                                    @qa.SpellingQuestion.CorrectLetter → @qa.SpellingQuestion.FullWord (@qa.SpellingQuestion.Points б.)
                                                </small>
                                            </div>
                                    
                                    
                                            @if (hasMistakes)
                                            {
                                                <span class="badge bg-danger badge-sm ms-2">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    <span class="d-none d-sm-inline ms-1">@qa.CommonMistakes.Count ош.</span>
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success badge-sm ms-2">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span class="d-none d-sm-inline ms-1">Без ошибок</span>
                                                </span>
                                            }
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="text-end">
                                            @if (qa.TotalAnswers > 0)
                                            {
                                                <div class="h4 mb-0 text-@(qa.SuccessRate >= 80 ? "success" : qa.SuccessRate >= 60 ? "warning" : "danger")">
                                                    @qa.SuccessRate.ToString("F0")%
                                                </div>
                                                <small class="text-muted">@qa.CorrectAnswers/@qa.TotalAnswers</small>
                                            }
                                            else
                                            {
                                                <span class="text-muted">—</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(qa.SpellingQuestion.Hint))
                            {
                                <div class="card-body py-2 bg-light">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>@qa.SpellingQuestion.Hint
                                    </small>
                                </div>
                            }

                            @if (qa.CommonMistakes.Any())
                            {
                                <div class="card-body pt-2">
                                    <div class="row g-2">
                                        @foreach (var mistake in qa.CommonMistakes.Take(4))
                                        {
                                            <div class="col-md-6">
                                                <div class="p-2 bg-light rounded border-start border-danger border-2">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <span class="fw-bold text-danger">"@mistake.IncorrectAnswer"</span>
                                                        <small class="badge bg-danger">@mistake.Count</small>
                                                    </div>
                                                    <div class="students-minimal">
                                                        @foreach (var name in mistake.StudentNames)
                                                        {
                                                            <span class="student-tag">@name</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    @if (qa.CommonMistakes.Count > 4)
                                    {
                                        <div class="text-center mt-2">
                                            <small class="text-muted">и еще @(qa.CommonMistakes.Count - 4) вариантов ошибок</small>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="card-body py-2 bg-light-success">
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Все ученики ответили правильно!
                                    </small>
                                </div>
                            }
                        </div>
                    }
                </div>
        
        
                <div id="noQuestionsMessage" class="card border-0 shadow-sm" style="display: none;">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-filter text-muted mb-3" style="font-size: 3rem;"></i>
                        <h5 class="text-muted mb-2">Вопросов не найдено</h5>
                        <p class="text-muted mb-3">Нет вопросов, соответствующих выбранному фильтру</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="resetFilter()">
                            <i class="fas fa-redo"></i> Сбросить фильтр
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_StudentDetailsModal")

@section Styles {
    <link rel="stylesheet" href="~/css/test-analytics.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/test-analytics-realtime.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
}

@functions {
    int GetGradeFromPercentage(double percentage)
    {
        if (percentage >= 91) return 5;
        if (percentage >= 76) return 4;
        if (percentage >= 61) return 3;
        return 2;
    }

    string GetGradeColor(int grade)
    {
        return grade switch
        {
            5 => "excellent",
            4 => "good",
            3 => "satisfactory",
            2 => "unsatisfactory",
            _ => "unsatisfactory"
        };
    }
}

@section Scripts {
    <script src="~/js/layout.js" asp-append-version="true"></script>
    <script src="~/js/test-analytics.js" asp-append-version="true"></script>
    <script src="~/js/test-analytics-realtime.js" asp-append-version="true"></script>

    <script>
        // ===== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =====
        const TEST_ID = @Model.SpellingTest.Id;
        const TEST_TYPE = 'spelling';
        const MAX_ATTEMPTS = @Model.SpellingTest.MaxAttempts;

        console.log('🚀 Инициализация аналитики теста орфографии', { TEST_ID, TEST_TYPE });

        // ===== ФУНКЦИИ ДЛЯ МОДАЛЬНОГО ОКНА ДЕТАЛЕЙ СТУДЕНТА =====
        
        /**
         * Показать детали студента
         * @@param {number} studentId - ID студента
         * @@param {string} studentName - Имя студента
         */
        function showStudentDetails(studentId, studentName) {
            console.log('👤 Открываем детали студента:', studentId, studentName);
            loadSpellingStudentDetails(studentId, studentName, TEST_ID);
        }

        /**
         * Загрузка данных для орфографии
         * @@param {number} studentId - ID студента
         * @@param {string} studentName - Имя студента
         * @@param {number} testId - ID теста
         */
        function loadSpellingStudentDetails(studentId, studentName, testId) {
            console.log('📡 Загрузка деталей студента:', { studentId, studentName, testId });

            // Сброс состояния модального окна
            if (window.testAnalytics && typeof window.testAnalytics.resetModalState === 'function') {
                window.testAnalytics.resetModalState();
            }

            // Устанавливаем имя студента
            const nameElement = document.getElementById('studentModalName');
            if (nameElement) {
                nameElement.textContent = studentName;
            }

            // Показываем индикатор загрузки
            if (window.testAnalytics && typeof window.testAnalytics.showLoading === 'function') {
                window.testAnalytics.showLoading();
            }

            // Открываем модальное окно
            const modalElement = document.getElementById('studentDetailsModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }

            // Загружаем данные с сервера
            fetch(`/TestAnalytics/GetStudentDetails?studentId=${studentId}&testId=${testId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('📥 Ответ сервера:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Ошибка загрузки данных`);
                }
                return response.json();
            })
            .then(data => {
                console.log('✅ Данные студента получены:', data);
                displaySpellingStudentDetails(data);
            })
            .catch(error => {
                console.error('❌ Ошибка загрузки деталей студента:', error);
                if (window.testAnalytics && typeof window.testAnalytics.showError === 'function') {
                    window.testAnalytics.showError(error.message);
                } else {
                    alert('Ошибка загрузки данных: ' + error.message);
                }
            });
        }

        /**
         * Отображение данных для орфографии
         * @@param {Object} data - Данные студента
         */
        function displaySpellingStudentDetails(data) {
            console.log('📊 Отображение деталей студента');

            // Отображаем базовую информацию
            if (window.testAnalytics && typeof window.testAnalytics.displayBasicStudentInfo === 'function') {
                window.testAnalytics.displayBasicStudentInfo(data);
            }

            // Отображаем анализ ошибок
            displaySpellingMistakesAnalysis(data.mistakes || []);

            // Показываем контент
            const contentElement = document.getElementById('studentModalContent');
            if (contentElement) {
                contentElement.style.display = 'block';
            }

            // Скрываем индикатор загрузки
            const loadingElement = document.getElementById('studentModalLoading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }

        /**
         * Анализ ошибок для орфографии
         * @@param {Array} mistakes - Массив ошибок
         */
        function displaySpellingMistakesAnalysis(mistakes) {
            console.log('📝 Отображение ошибок:', mistakes.length);

            const container = document.getElementById('studentMistakes');
            if (!container) {
                console.warn('⚠️ Контейнер studentMistakes не найден');
                return;
            }

            if (!mistakes || mistakes.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Ошибок не найдено!</strong> Отличная работа!
                    </div>
                `;
                return;
            }

            let html = '<div class="row g-2">';
            mistakes.forEach(mistake => {
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="p-2 bg-light rounded border-start border-danger border-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold text-danger">"${mistake.incorrectAnswer || 'Пустой ответ'}"</span>
                                <span class="badge bg-danger">${mistake.count}</span>
                            </div>
                            <div class="mt-1">
                                <small class="text-muted d-block">
                                    Правильно: <strong class="text-success">${mistake.correctAnswer}</strong>
                                </small>
                                <small class="text-muted">Слово: ${mistake.fullWord}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // ===== ФИЛЬТРАЦИЯ ВОПРОСОВ =====

        /**
         * Фильтрация вопросов по наличию ошибок
         */
        function filterQuestions() {
            const filterCheckbox = document.getElementById('filterMistakesOnly');
            if (!filterCheckbox) {
                console.warn('⚠️ Чекбокс фильтра не найден');
                return;
            }

            const showOnlyMistakes = filterCheckbox.checked;
            console.log('🔍 Фильтрация вопросов. Только ошибки:', showOnlyMistakes);
    
            const allQuestions = document.querySelectorAll('.question-analytics-card');
            const noQuestionsMessage = document.getElementById('noQuestionsMessage');
            let visibleCount = 0;
    
            allQuestions.forEach(question => {
                const hasMistakes = question.dataset.hasMistakes === 'true';
        
                if (showOnlyMistakes) {
                    // Показываем только вопросы с ошибками
                    if (hasMistakes) {
                        question.style.display = 'block';
                        visibleCount++;
                        question.classList.add('fade-in');
                    } else {
                        question.style.display = 'none';
                    }
                } else {
                    // Показываем все вопросы
                    question.style.display = 'block';
                    visibleCount++;
                    question.classList.add('fade-in');
                }
            });
    
            // Показываем/скрываем сообщение "Вопросов не найдено"
            if (noQuestionsMessage) {
                if (visibleCount === 0) {
                    noQuestionsMessage.style.display = 'block';
                    noQuestionsMessage.classList.add('fade-in');
                } else {
                    noQuestionsMessage.style.display = 'none';
                }
            }
    
            // Убираем класс анимации после завершения
            setTimeout(() => {
                allQuestions.forEach(q => q.classList.remove('fade-in'));
                if (noQuestionsMessage) {
                    noQuestionsMessage.classList.remove('fade-in');
                }
            }, 300);
    
            // Обновляем счетчик
            updateQuestionsCounter(visibleCount, allQuestions.length);
            
            console.log('✅ Фильтрация завершена. Показано:', visibleCount, 'из', allQuestions.length);
        }

        /**
         * Обновление счетчика вопросов
         * @@param {number} visibleCount - Количество видимых вопросов
         * @@param {number} totalCount - Общее количество вопросов
         */
        function updateQuestionsCounter(visibleCount, totalCount) {
            const questionsCount = document.getElementById('questionsCount');
            if (questionsCount) {
                questionsCount.textContent = `Показано: ${visibleCount} из ${totalCount}`;
            }
        }

        /**
         * Сброс фильтра
         */
        function resetFilter() {
            console.log('🔄 Сброс фильтра');
            const filterCheckbox = document.getElementById('filterMistakesOnly');
            if (filterCheckbox) {
                filterCheckbox.checked = false;
                filterQuestions();
            }
        }

        // ===== КНОПКА УПРАВЛЕНИЯ АВТООБНОВЛЕНИЕМ =====

        /**
         * Добавление кнопки управления автообновлением
         */
        function addRealtimeControls() {
            console.log('🎛️ Добавление элементов управления автообновлением');

            const breadcrumbContainer = document.querySelector('.d-flex.justify-content-between.align-items-center.mb-2 .flex-shrink-0');
            if (!breadcrumbContainer) {
                console.warn('⚠️ Контейнер для кнопок управления не найден');
                return;
            }

            const controlsHtml = `
                <button id="toggleRealtime" class="btn btn-outline-primary btn-sm me-2" onclick="toggleRealtime()" title="Включить/выключить автообновление">
                    <i class="fas fa-sync"></i>
                    <span id="realtimeStatus">Вкл</span>
                </button>
            `;
            breadcrumbContainer.insertAdjacentHTML('afterbegin', controlsHtml);
            console.log('✅ Кнопка управления добавлена');
        }

        /**
         * Переключение режима автообновления
         */
        function toggleRealtime() {
            const button = document.getElementById('toggleRealtime');
            const status = document.getElementById('realtimeStatus');
            
            if (!window.testAnalyticsRealtime) {
                console.error('❌ testAnalyticsRealtime не инициализирован');
                return;
            }

            // Переключаем polling
            if (window.testAnalyticsRealtime.intervalId) {
                console.log('⏸️ Остановка автообновления');
                window.testAnalyticsRealtime.stop();
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-outline-secondary');
                status.textContent = 'Выкл';
            } else {
                console.log('▶️ Запуск автообновления');
                window.testAnalyticsRealtime.start();
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-primary');
                status.textContent = 'Вкл';
            }
        }

        // ===== ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ СТРАНИЦЫ =====

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOMContentLoaded - начало инициализации');

            try {
                // ===== 1. ДОБАВЛЯЕМ DATA-АТРИБУТЫ К СТРОКАМ ТАБЛИЦЫ =====
                console.log('📋 Шаг 1: Добавление data-student-id');
                const studentIds = @Html.Raw(Json.Serialize(Model.SpellingResults.Select(r => r.Student.Id).ToList()));
                const studentRows = document.querySelectorAll('#students table tbody tr');
                
                console.log('👥 Найдено строк студентов:', studentRows.length);
                console.log('🆔 ID студентов:', studentIds);
                
                studentRows.forEach((row, index) => {
                    if (studentIds[index]) {
                        row.setAttribute('data-student-id', studentIds[index]);
                    }
                });

                console.log('✅ Добавлены data-student-id к', studentRows.length, 'строкам');

                // ===== 2. ДОБАВЛЯЕМ DATA-АТРИБУТЫ К КАРТОЧКАМ ВОПРОСОВ =====
                console.log('📋 Шаг 2: Добавление data-question-id');
                const questionIds = @Html.Raw(Json.Serialize(Model.SpellingQuestionAnalytics.Select(q => q.SpellingQuestion.Id).ToList()));
                const questionCards = document.querySelectorAll('.question-analytics-card');
                
                console.log('❓ Найдено карточек вопросов:', questionCards.length);
                console.log('🆔 ID вопросов:', questionIds);
                
                questionCards.forEach((card, index) => {
                    if (questionIds[index]) {
                        card.setAttribute('data-question-id', questionIds[index]);
                    }
                });

                console.log('✅ Добавлены data-question-id к', questionCards.length, 'карточкам');

                // ===== 3. ЗАПУСКАЕМ POLLING =====
                console.log('📋 Шаг 3: Запуск Polling');
                window.testAnalyticsRealtime = new TestAnalyticsRealtime(
                    TEST_ID,        // testId
                    60000,          // updateInterval (60 секунд)
                    TEST_TYPE       // testType ('spelling')
                );
                window.testAnalyticsRealtime.start();
                console.log('✅ Polling запущен:', { testId: TEST_ID, interval: '60s', type: TEST_TYPE });

                // ===== 4. ДОБАВЛЯЕМ КНОПКУ УПРАВЛЕНИЯ =====
                console.log('📋 Шаг 5: Добавление кнопки управления');
                addRealtimeControls();

                // ===== 5. НАСТРОЙКА ФИЛЬТРОВ ВОПРОСОВ =====
                console.log('📋 Шаг 6: Настройка фильтров вопросов');
                
                const questionsTab = document.getElementById('questions-tab');
                if (questionsTab) {
                    questionsTab.addEventListener('shown.bs.tab', function (e) {
                        console.log('📑 Вкладка "Анализ" открыта');
                        const filterCheckbox = document.getElementById('filterMistakesOnly');
                        if (filterCheckbox && !filterCheckbox.dataset.initialized) {
                            filterCheckbox.checked = true;
                            filterCheckbox.dataset.initialized = 'true';
                            filterQuestions();
                        }
                    });
                    console.log('✅ Обработчик вкладки "Анализ" добавлен');
                }
        
                // Если вкладка "Анализ" активна при загрузке страницы
                const questionsPane = document.getElementById('questions');
                if (questionsPane && questionsPane.classList.contains('show')) {
                    console.log('📑 Вкладка "Анализ" активна при загрузке');
                    const filterCheckbox = document.getElementById('filterMistakesOnly');
                    if (filterCheckbox) {
                        filterCheckbox.checked = true;
                        filterCheckbox.dataset.initialized = 'true';
                        filterQuestions();
                    }
                }

                console.log('🎉 Инициализация успешно завершена!');

            } catch (error) {
                console.error('❌ Ошибка при инициализации:', error);
                alert('Произошла ошибка при инициализации страницы. Проверьте консоль для деталей.');
            }
        });

        // ===== ОСТАНОВКА ПРИ УХОДЕ СО СТРАНИЦЫ =====

        window.addEventListener('beforeunload', function() {
            console.log('🛑 Страница закрывается - остановка всех подключений');
            
            try {
                if (window.testAnalyticsRealtime) {
                    window.testAnalyticsRealtime.stop();
                    console.log('⏹️ Polling остановлен');
                }
            } catch (error) {
                console.error('❌ Ошибка при остановке подключений:', error);
            }
        });

        // ===== ОБРАБОТКА ВИДИМОСТИ СТРАНИЦЫ =====

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Страница скрыта - приостанавливаем polling
                console.log('⏸️ Страница скрыта - приостановка polling');
                if (window.testAnalyticsRealtime && window.testAnalyticsRealtime.intervalId) {
                    window.testAnalyticsRealtime.stop();
                }
            } else {
                // Страница снова видна - возобновляем polling
                console.log('▶️ Страница видна - возобновление polling');
                if (window.testAnalyticsRealtime && !window.testAnalyticsRealtime.intervalId) {
                    window.testAnalyticsRealtime.start();
                }
            }
        });

        // ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ ОТЛАДКИ =====

        window.debugAnalytics = function() {
            console.log('🔍 Отладочная информация:');
            console.log('- Test ID:', TEST_ID);
            console.log('- Test Type:', TEST_TYPE);
            console.log('- Polling активен:', window.testAnalyticsRealtime?.intervalId !== null);
            console.log('- Строк студентов:', document.querySelectorAll('#students table tbody tr[data-student-id]').length);
            console.log('- Карточек вопросов:', document.querySelectorAll('.question-analytics-card[data-question-id]').length);
        };

        console.log('💡 Подсказка: используйте debugAnalytics() в консоли для отладки');

    </script>
}
