@model OnlineTutor2.ViewModels.TeacherDashboardViewModel
@{
    ViewData["Title"] = "Панель мониторинга";
}

<div class="container-fluid px-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-tachometer-alt text-primary me-2"></i>
                Панель мониторинга
            </h2>
            <p class="text-muted mb-0">Активность студентов в реальном времени</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div id="signalr-status" class="signalr-status" style="display: none;">
                <i class="fas fa-circle text-secondary me-1"></i>
                <span>Подключение...</span>
            </div>
            <div id="signalr-activity-indicator"></div>
        </div>
    </div>

    <div class="row g-2 g-md-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm stat-card-compact">
                <div class="card-body text-center p-2 p-md-3">
                    <i class="fas fa-clipboard-list text-primary stat-icon mb-1 mb-md-2"></i>
                    <h3 class="stat-number mb-0">@Model.TotalActiveTests</h3>
                    <small class="text-muted stat-label">Активных тестов</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm stat-card-compact">
                <div class="card-body text-center p-2 p-md-3">
                    <i class="fas fa-clock text-warning stat-icon mb-1 mb-md-2"></i>
                    <h3 class="stat-number mb-0" id="stats-in-progress">@Model.TotalStudentsInProgress</h3>
                    <small class="text-muted stat-label">Проходят сейчас</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm stat-card-compact">
                <div class="card-body text-center p-2 p-md-3">
                    <i class="fas fa-check-circle text-success stat-icon mb-1 mb-md-2"></i>
                    <h3 class="stat-number mb-0" id="stats-completed-today">@Model.TotalCompletedToday</h3>
                    <small class="text-muted stat-label">Завершено сегодня</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm stat-card-compact">
                <div class="card-body text-center p-2 p-md-3">
                    <i class="fas fa-bell text-info stat-icon mb-1 mb-md-2"></i>
                    <h3 class="stat-number mb-0" id="stats-notifications">0</h3>
                    <small class="text-muted stat-label">Уведомлений сегодня</small>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                <i class="fas fa-stream"></i> Активность
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests" type="button" role="tab">
                <i class="fas fa-list"></i> Тесты
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        
        
        <div class="tab-pane fade show active" id="activity" role="tabpanel">
            
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-search text-primary"></i>
                            <strong class="small">Поиск:</strong>
                        </div>
            
                        <div class="flex-grow-1" style="max-width: 400px;">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" 
                                       class="form-control" 
                                       id="activitySearchInput" 
                                       placeholder="Поиск по имени студента или названию теста..."
                                       onkeyup="filterActivities()">
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        id="clearActivitySearch"
                                        onclick="clearActivitySearch()"
                                        style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
            
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                                <i class="fas fa-sync"></i>
                                <span class="d-none d-sm-inline ms-1">Обновить</span>
                            </button>
                            <span class="badge bg-secondary" id="activityCount">
                                Показано: 0
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-compact mb-0" id="activityTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Уведомление</th>
                                    <th class="text-center d-none d-md-table-cell">Процент</th>
                                    <th class="text-center">Оценка</th>
                                    <th class="text-center d-none d-md-table-cell">Время</th>
                                    <th class="text-center">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="activity-feed">
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                        <p class="text-muted mt-2 mb-0 small">Загрузка активности...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="noActivityResults" class="text-center py-5" style="display: none;">
                        <i class="fas fa-search text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                        <h5 class="text-muted mb-2">Ничего не найдено</h5>
                        <p class="text-muted mb-3">Попробуйте изменить поисковый запрос</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="clearActivitySearch()">
                            <i class="fas fa-redo"></i> Сбросить поиск
                        </button>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="tab-pane fade" id="tests" role="tabpanel">
    
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-search text-primary"></i>
                            <strong class="small">Поиск:</strong>
                        </div>
    
                        <div class="flex-grow-1" style="max-width: 400px;">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" 
                                       class="form-control" 
                                       id="testsSearchInput" 
                                       placeholder="Поиск по названию теста или классу..."
                                       onkeyup="filterTests()">
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        id="clearTestsSearch"
                                        onclick="clearTestsSearch()"
                                        style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
    
                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterAll" value="all" checked onchange="filterTests()">
                                <label class="btn btn-outline-secondary" for="filterAll">
                                    <i class="fas fa-list me-1"></i>
                                    <span class="d-none d-sm-inline">Все</span>
                                </label>
                        
                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterSpelling" value="spelling" onchange="filterTests()">
                                <label class="btn btn-outline-primary" for="filterSpelling">
                                    <i class="fas fa-spell-check"></i>
                                </label>
                        
                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterPunctuation" value="punctuation" onchange="filterTests()">
                                <label class="btn btn-outline-info" for="filterPunctuation">
                                    <i class="fas fa-paragraph"></i>
                                </label>
                        
                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterOrthoepy" value="orthoepy" onchange="filterTests()">
                                <label class="btn btn-outline-danger" for="filterOrthoepy">
                                    <i class="fas fa-volume-up"></i>
                                </label>
                        
                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterRegular" value="regular" onchange="filterTests()">
                                <label class="btn btn-outline-secondary" for="filterRegular">
                                    <i class="fas fa-question-circle"></i>
                                </label>
                            </div>
                    
                            <span class="badge bg-secondary" id="testsCount">
                                Показано: 0
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-compact mb-0" id="testsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Название теста</th>
                                    <th class="d-none d-lg-table-cell">Тип</th>
                                    <th class="d-none d-md-table-cell">Класс</th>
                                    <th class="text-center">Завершено</th>
                                    <th class="text-center">В процессе</th>
                                    <th class="text-center">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody">
                                @* Орфография *@
                                @foreach (var test in Model.SpellingTests)
                                {
                                    <tr class="test-row" 
                                        data-test-type="spelling" 
                                        data-test-id="@test.Id"
                                        data-search-text="@(test.Title.ToLower()) @(test.Class?.Name.ToLower() ?? "все классы")">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge bg-primary test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-spell-check"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block">@test.Title</strong>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                    @if (test.Class != null)
                                                    {
                                                        <small class="text-muted d-md-none d-block">
                                                            <i class="fas fa-users me-1"></i>@test.Class.Name
                                                        </small>
                                                    }
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge bg-primary test-type-badge">
                                                <i class="fas fa-spell-check me-1"></i>
                                                Орфография
                                            </span>
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            @if (test.Class != null)
                                            {
                                                <i class="fas fa-users me-1"></i><span>@test.Class.Name</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-globe me-1"></i><span class="text-muted">Все классы</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success test-count-completed" data-test-id="@test.Id" data-test-type="spelling">
                                                @test.SpellingTestResults.Count(r => r.IsCompleted)
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning test-count-progress" data-test-id="@test.Id" data-test-type="spelling">
                                                @test.SpellingTestResults.Count(r => !r.IsCompleted)
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="TestAnalytics" asp-action="Spelling" asp-route-id="@test.Id" 
                                                class="btn btn-sm btn-outline-primary" title="Открыть аналитику">
                                                <i class="fas fa-chart-bar"></i>
                                                <span class="d-none d-md-inline">Аналитика</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @* Пунктуация *@
                                @foreach (var test in Model.PunctuationTests)
                                {
                                    <tr class="test-row" 
                                        data-test-type="punctuation" 
                                        data-test-id="@test.Id"
                                        data-search-text="@(test.Title.ToLower()) @(test.Class?.Name.ToLower() ?? "все классы")">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge bg-info test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-paragraph"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block">@test.Title</strong>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                    @if (test.Class != null)
                                                    {
                                                        <small class="text-muted d-md-none d-block">
                                                            <i class="fas fa-users me-1"></i>@test.Class.Name
                                                        </small>
                                                    }
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge bg-info test-type-badge">
                                                <i class="fas fa-paragraph me-1"></i>
                                                Пунктуация
                                            </span>
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            @if (test.Class != null)
                                            {
                                                <i class="fas fa-users me-1"></i><span>@test.Class.Name</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-globe me-1"></i><span class="text-muted">Все классы</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success test-count-completed" data-test-id="@test.Id" data-test-type="punctuation">
                                                @test.PunctuationTestResults.Count(r => r.IsCompleted)
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning test-count-progress" data-test-id="@test.Id" data-test-type="punctuation">
                                                @test.PunctuationTestResults.Count(r => !r.IsCompleted)
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="TestAnalytics" asp-action="Punctuation" asp-route-id="@test.Id" 
                                                class="btn btn-sm btn-outline-primary" title="Открыть аналитику">
                                                <i class="fas fa-chart-bar"></i>
                                                <span class="d-none d-md-inline">Аналитика</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @* Орфоэпия *@
                                @foreach (var test in Model.OrthoeopyTests)
                                {
                                    <tr class="test-row" 
                                        data-test-type="orthoepy" 
                                        data-test-id="@test.Id"
                                        data-search-text="@(test.Title.ToLower()) @(test.Class?.Name.ToLower() ?? "все классы")">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge bg-danger test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-volume-up"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block">@test.Title</strong>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                    @if (test.Class != null)
                                                    {
                                                        <small class="text-muted d-md-none d-block">
                                                            <i class="fas fa-users me-1"></i>@test.Class.Name
                                                        </small>
                                                    }
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge bg-danger test-type-badge">
                                                <i class="fas fa-volume-up me-1"></i>
                                                Орфоэпия
                                            </span>
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            @if (test.Class != null)
                                            {
                                                <i class="fas fa-users me-1"></i><span>@test.Class.Name</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-globe me-1"></i><span class="text-muted">Все классы</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success test-count-completed" data-test-id="@test.Id" data-test-type="orthoepy">
                                                @test.OrthoeopyTestResults.Count(r => r.IsCompleted)
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning test-count-progress" data-test-id="@test.Id" data-test-type="orthoepy">
                                                @test.OrthoeopyTestResults.Count(r => !r.IsCompleted)
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="TestAnalytics" asp-action="Orthoepy" asp-route-id="@test.Id" 
                                                class="btn btn-sm btn-outline-primary" title="Открыть аналитику">
                                                <i class="fas fa-chart-bar"></i>
                                                <span class="d-none d-md-inline">Аналитика</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @* Классические *@
                                @foreach (var test in Model.RegularTests)
                                {
                                    <tr class="test-row" 
                                        data-test-type="regular" 
                                        data-test-id="@test.Id"
                                        data-search-text="@(test.Title.ToLower()) @(test.Class?.Name.ToLower() ?? "все классы")">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge bg-secondary test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-question-circle"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block">@test.Title</strong>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                    @if (test.Class != null)
                                                    {
                                                        <small class="text-muted d-md-none d-block">
                                                            <i class="fas fa-users me-1"></i>@test.Class.Name
                                                        </small>
                                                    }
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge bg-secondary test-type-badge">
                                                <i class="fas fa-question-circle me-1"></i>
                                                Классический
                                            </span>
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            @if (test.Class != null)
                                            {
                                                <i class="fas fa-users me-1"></i><span>@test.Class.Name</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-globe me-1"></i><span class="text-muted">Все классы</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success test-count-completed" data-test-id="@test.Id" data-test-type="regular">
                                                @test.RegularTestResults.Count(r => r.IsCompleted)
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning test-count-progress" data-test-id="@test.Id" data-test-type="regular">
                                                @test.RegularTestResults.Count(r => !r.IsCompleted)
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="TestAnalytics" asp-action="Regular" asp-route-id="@test.Id" 
                                                class="btn btn-sm btn-outline-primary" title="Открыть аналитику">
                                                <i class="fas fa-chart-bar"></i>
                                                <span class="d-none d-md-inline">Аналитика</span>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div id="noTestsResults" class="text-center py-5" style="display: none;">
                        <i class="fas fa-search text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                        <h5 class="text-muted mb-2">Тесты не найдены</h5>
                        <p class="text-muted mb-3">Попробуйте изменить поисковый запрос или фильтр</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="clearTestsSearch()">
                            <i class="fas fa-redo"></i> Сбросить фильтры
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="testResultModal" tabindex="-1" aria-labelledby="testResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testResultModalTitle">Результат теста</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="testResultModalBody">
                </div>
            </div>
        </div>
    </div>

</div>

@section Styles {
    <link rel="stylesheet" href="~/css/teacher-dashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/test-analytics-signalr.css" asp-append-version="true" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <script src="~/js/teacher-dashboard-signalr.js" asp-append-version="true"></script>
    
    <script>
        var TEACHER_ID = '@Model.Teacher.Id';
        var notificationCount = 0;
        var allActivities = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Инициализация Dashboard');

            document.getElementById('signalr-status').style.display = 'inline-flex';

            loadRecentActivity();

            window.dashboardSignalR = new TeacherDashboardSignalR(TEACHER_ID);
            window.dashboardSignalR.start();

            var searchInput = document.getElementById('activitySearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    var clearBtn = document.getElementById('clearActivitySearch');
                    if (clearBtn) {
                        clearBtn.style.display = this.value ? 'block' : 'none';
                    }
                });
            }

            console.log('✅ Dashboard инициализирован');
        });

        // ===== ЗАГРУЗКА АКТИВНОСТИ =====

        async function loadRecentActivity() {
            console.log('📡 Загрузка активности...');
            try {
                var response = await fetch('/TeacherDashboard/GetRecentActivity');
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                var activities = await response.json();
                console.log('✅ Получено активностей:', activities.length);
                
                allActivities = activities;
                displayActivities(activities);
            } catch (error) {
                console.error('❌ Ошибка загрузки активности:', error);
                var feed = document.getElementById('activity-feed');
                if (feed) {
                    feed.innerHTML = 
                        '<tr><td colspan="5" class="text-center py-5">' +
                        '<i class="fas fa-exclamation-triangle text-warning fs-1 mb-3"></i>' +
                        '<p class="text-muted">Ошибка загрузки данных</p>' +
                        '<button class="btn btn-primary btn-sm" onclick="loadRecentActivity()">' +
                        '<i class="fas fa-redo"></i> Попробовать снова' +
                        '</button>' +
                        '</td></tr>';
                }
            }
        }

        // ===== ОТОБРАЖЕНИЕ АКТИВНОСТИ С ГРУППИРОВКОЙ ПО ДНЯМ =====

        function displayActivities(activities) {
            var feed = document.getElementById('activity-feed');
            var noResults = document.getElementById('noActivityResults');
            
            if (!activities || activities.length === 0) {
                feed.innerHTML = 
                    '<tr><td colspan="5" class="text-center py-5">' +
                    '<i class="fas fa-inbox text-muted fs-1 mb-3" style="opacity: 0.3;"></i>' +
                    '<p class="text-muted mb-0">Пока нет активности</p>' +
                    '</td></tr>';
                
                if (noResults) noResults.style.display = 'none';
                updateActivityCount(0);
                return;
            }

            // Группируем по дням
            var groupedActivities = groupActivitiesByDate(activities);
            
            var html = '';
            var totalCount = 0;
            
            Object.keys(groupedActivities).forEach(function(dateKey, index) {
                var group = groupedActivities[dateKey];
                var isToday = index === 0; // Первая группа - сегодня
                var isExpanded = isToday; // По умолчанию раскрыта только сегодняшняя
                
                html += createDateGroupHeader(group.label, group.activities.length, dateKey, isExpanded);
                
                group.activities.forEach(function(activity) {
                    html += createActivityRow(activity, dateKey, isExpanded);
                    totalCount++;
                });
            });
            
            feed.innerHTML = html;
            if (noResults) noResults.style.display = 'none';
            updateActivityCount(totalCount);
        }

        // ===== ГРУППИРОВКА ПО ДАТАМ =====

        function groupActivitiesByDate(activities) {
            var groups = {};
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            
            var yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            activities.forEach(function(activity) {
                var activityDate = new Date(activity.lastActivityAt);
                activityDate.setHours(0, 0, 0, 0);
                
                var dateKey;
                var label;
                
                if (activityDate.getTime() === today.getTime()) {
                    dateKey = 'today';
                    label = 'Сегодня';
                } else if (activityDate.getTime() === yesterday.getTime()) {
                    dateKey = 'yesterday';
                    label = 'Вчера';
                } else {
                    dateKey = 'date_' + activityDate.getTime();
                    label = formatDate(activityDate);
                }
                
                if (!groups[dateKey]) {
                    groups[dateKey] = {
                        label: label,
                        date: activityDate,
                        activities: []
                    };
                }
                
                groups[dateKey].activities.push(activity);
            });
            
            // Сортируем группы по дате (новые первыми)
            var sortedGroups = {};
            Object.keys(groups)
                .sort(function(a, b) {
                    return groups[b].date - groups[a].date;
                })
                .forEach(function(key) {
                    sortedGroups[key] = groups[key];
                });
            
            return sortedGroups;
        }

        // ===== СОЗДАНИЕ ЗАГОЛОВКА ГРУППЫ =====

        function createDateGroupHeader(label, count, dateKey, isExpanded) {
            var icon = isExpanded ? 'fa-chevron-down' : 'fa-chevron-right';
            
            return '<tr class="date-group-header" onclick="toggleDateGroup(\'' + dateKey + '\')">' +
                   '<td colspan="5" class="py-2 px-3">' +
                   '<div class="d-flex align-items-center justify-content-between">' +
                   '<div class="d-flex align-items-center gap-2">' +
                   '<i class="fas ' + icon + ' text-primary date-group-icon" id="icon-' + dateKey + '"></i>' +
                   '<strong>' + label + '</strong>' +
                   '<span class="badge bg-secondary badge-sm">' + count + '</span>' +
                   '</div>' +
                   '</div>' +
                   '</td>' +
                   '</tr>';
        }

        // ===== СОЗДАНИЕ СТРОКИ АКТИВНОСТИ =====

        function createActivityRow(activity, dateKey, isVisible) {
            var timeAgo = formatTimeAgo(new Date(activity.lastActivityAt));
            var testTypeIcon = getTestTypeIcon(activity.testType);
            var testTypeColor = getTestTypeColor(activity.testType);
            
            var actionText;
            switch (activity.action) {
                case 'completed':
                    actionText = 'завершил';
                    break;
                case 'continued':
                    actionText = 'продолжил';
                    break;
                case 'started':
                default:
                    actionText = 'начал';
                    break;
            }

            var percentBadge = '';
            var gradeBadge = '';
            
            // Для завершенных тестов показываем процент и оценку
            if (activity.status === 'completed' && activity.percentage !== undefined) {
                var percentColor = activity.percentage >= 80 ? 'success' : 
                                  activity.percentage >= 60 ? 'warning' : 'danger';
                percentBadge = '<span class="badge bg-' + percentColor + ' badge-sm">' + 
                               activity.percentage.toFixed(1) + '%</span>';
        
                var grade = getGradeFromPercentage(activity.percentage);
                var gradeColor = getGradeColor(grade);
                gradeBadge = '<span class="grade-badge-compact grade-' + gradeColor + '">' + grade + '</span>';
            } else {
                percentBadge = '<span class="text-muted">—</span>';
                gradeBadge = '<span class="text-muted">—</span>';
            }

            var resultButton = '';
            if (activity.status === 'completed' && activity.testResultId) {
                resultButton = 
                    '<button class="btn btn-outline-info btn-sm" ' +
                    'onclick="showTestResultModal(\'' + activity.testType + '\', ' + activity.testResultId + ', \'' + activity.studentName + '\')" ' +
                    'title="Посмотреть результат">' +
                    '<i class="fas fa-eye me-md-2"></i>' +
                    '<span class="d-none d-md-inline">Результат</span>' +
                    '</button>';
            }

            var displayStyle = isVisible ? '' : 'display: none;';

            return '<tr class="activity-row date-group-' + dateKey + '" ' +
                   'data-activity-id="' + activity.testId + '_' + activity.studentId + '" ' +
                   'data-search-text="' + (activity.studentName + ' ' + activity.testTitle).toLowerCase() + '" ' +
                   'data-date-group="' + dateKey + '" ' +
                   'style="' + displayStyle + '">' +
                   
                   '<td>' +
                   '<div class="d-flex align-items-center gap-2">' +
                   '<div class="activity-icon-small bg-' + testTypeColor + '">' +
                   '<i class="fas ' + testTypeIcon + '"></i>' +
                   '</div>' +
                   '<div class="flex-grow-1 min-w-0">' +
                   '<span class="d-block" style="line-height: 1.4;">' +
                   '<strong>' + activity.studentName + '</strong> ' +
                   actionText + ' ' +
                   '<span class="text-muted"><strong>' + activity.testTitle + '</strong></span>' +
                   '</span>' +
                   '</div>' +
                   '</div>' +
                   '</td>' +
                   
                   '<td class="text-center d-none d-md-table-cell">' +
                   percentBadge +
                   '</td>' +
                   
                   '<td class="text-center">' +
                   gradeBadge +
                   '</td>' +
                   
                   '<td class="text-center d-none d-md-table-cell">' +
                   '<small class="text-muted">' + timeAgo + '</small>' +
                   '</td>' +
                   
                   '<td class="text-center">' +
                   resultButton +
                   '</td>' +
                   
                   '</tr>';
        }

        // ===== ПЕРЕКЛЮЧЕНИЕ ГРУППЫ ДНЕЙ =====

        function toggleDateGroup(dateKey) {
            var rows = document.querySelectorAll('.date-group-' + dateKey);
            var icon = document.getElementById('icon-' + dateKey);
            
            if (!rows.length || !icon) return;
            
            var isVisible = rows[0].style.display !== 'none';
            
            rows.forEach(function(row) {
                row.style.display = isVisible ? 'none' : '';
            });
            
            icon.className = isVisible ? 
                'fas fa-chevron-right text-primary date-group-icon' : 
                'fas fa-chevron-down text-primary date-group-icon';
            
            filterActivities();
        }

        // ===== ФИЛЬТРАЦИЯ АКТИВНОСТИ =====

        function filterActivities() {
            var searchInput = document.getElementById('activitySearchInput');
            if (!searchInput) return;

            var searchText = searchInput.value.toLowerCase().trim();

            var rows = document.querySelectorAll('.activity-row');
            var visibleCount = 0;
            
            var groupCounts = {};

            rows.forEach(function(row) {
                var rowSearchText = row.getAttribute('data-search-text') || '';
                var dateGroup = row.getAttribute('data-date-group');
                var groupIcon = document.getElementById('icon-' + dateGroup);
                var isGroupExpanded = groupIcon && groupIcon.classList.contains('fa-chevron-down');
                
                if (!groupCounts[dateGroup]) {
                    groupCounts[dateGroup] = { total: 0, visible: 0 };
                }
                groupCounts[dateGroup].total++;
                
                var matchesSearch = !searchText || rowSearchText.includes(searchText);
                
                if (matchesSearch && isGroupExpanded) {
                    row.style.display = '';
                    groupCounts[dateGroup].visible++;
                    visibleCount++;
                } else if (matchesSearch && !isGroupExpanded) {
                    row.style.display = 'none';
                } else {
                    row.style.display = 'none';
                }
            });

            // Обновляем счётчики в заголовках групп
            Object.keys(groupCounts).forEach(function(dateGroup) {
                var header = document.querySelector('.date-group-header [id^="icon-' + dateGroup + '"]');
                if (header) {
                    var badge = header.parentElement.parentElement.querySelector('.badge');
                    if (badge) {
                        var count = groupCounts[dateGroup];
                        if (searchText && count.visible !== count.total) {
                            badge.textContent = count.visible + ' / ' + count.total;
                            badge.classList.add('bg-primary');
                            badge.classList.remove('bg-secondary');
                        } else {
                            badge.textContent = count.total;
                            badge.classList.add('bg-secondary');
                            badge.classList.remove('bg-primary');
                        }
                    }
                }
            });

            var noResults = document.getElementById('noActivityResults');
            var tableBody = document.getElementById('activity-feed');
            
            if (visibleCount === 0 && searchText) {
                if (tableBody) tableBody.style.display = 'none';
                if (noResults) noResults.style.display = 'block';
            } else {
                if (tableBody) tableBody.style.display = '';
                if (noResults) noResults.style.display = 'none';
            }

            updateActivityCount(visibleCount);
        }

        function clearActivitySearch() {
            var searchInput = document.getElementById('activitySearchInput');
            var clearBtn = document.getElementById('clearActivitySearch');
            
            if (searchInput) {
                searchInput.value = '';
            }
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
            
            filterActivities();
        }

        function updateActivityCount(count) {
            var countElement = document.getElementById('activityCount');
            if (countElement) {
                var total = document.querySelectorAll('.activity-row').length;
                countElement.textContent = 'Показано: ' + count + (count !== total ? ' из ' + total : '');
            }
        }

        // ===== ОБНОВЛЕНИЕ АКТИВНОСТИ =====

        function refreshActivity() {
            console.log('🔄 Ручное обновление активности');
            loadRecentActivity();
        }

        // ===== ДОБАВЛЕНИЕ НОВОЙ АКТИВНОСТИ =====

        function prependActivity(activity) {
            console.log('➕ Добавление новой активности');
            
            allActivities.unshift(activity);
            if (allActivities.length > 100) {
                allActivities.pop();
            }
            
            displayActivities(allActivities);
        }

        // ===== ОБНОВЛЕНИЕ СТАТИСТИКИ =====

        function updateStats(action) {
            if (action === 'completed') {
                var completedEl = document.getElementById('stats-completed-today');
                if (completedEl) {
                    var current = parseInt(completedEl.textContent) || 0;
                    completedEl.textContent = current + 1;
                    animateNumber(completedEl);
                }
            } else if (action === 'started') {
                var inProgressEl = document.getElementById('stats-in-progress');
                if (inProgressEl) {
                    var current = parseInt(inProgressEl.textContent) || 0;
                    inProgressEl.textContent = current + 1;
                    animateNumber(inProgressEl);
                }
            }

            var notificationsEl = document.getElementById('stats-notifications');
            if (notificationsEl) {
                notificationCount++;
                notificationsEl.textContent = notificationCount;
                animateNumber(notificationsEl);
            }
        }

        function animateNumber(element) {
            element.classList.add('number-change');
            setTimeout(function() {
                element.classList.remove('number-change');
            }, 600);
        }

        // ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====

        function getTestTypeIcon(type) {
            var icons = {
                'spelling': 'fa-spell-check',
                'punctuation': 'fa-paragraph',
                'orthoepy': 'fa-volume-up',
                'regular': 'fa-question-circle'
            };
            return icons[type] || 'fa-clipboard-list';
        }

        function getTestTypeColor(type) {
            var colors = {
                'spelling': 'primary',
                'punctuation': 'info',
                'orthoepy': 'danger',
                'regular': 'secondary'
            };
            return colors[type] || 'secondary';
        }

        function getGradeFromPercentage(percentage) {
            if (percentage >= 91) return 5;
            if (percentage >= 76) return 4;
            if (percentage >= 61) return 3;
            return 2;
        }

        function getGradeColor(grade) {
            var colors = {
                5: 'excellent',
                4: 'good',
                3: 'satisfactory',
                2: 'unsatisfactory'
            };
            return colors[grade] || 'unsatisfactory';
        }

        function formatTimeAgo(date) {
            var seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'только что';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' мин назад';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' ч назад';
            
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(date) {
            return date.toLocaleDateString('ru-RU', { 
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
        }

        // ===== ОСТАНОВКА ПРИ ВЫХОДЕ =====

        window.addEventListener('beforeunload', function() {
            if (window.dashboardSignalR) {
                window.dashboardSignalR.stop();
            }
        });

        // ===== ПОИСК И ФИЛЬТРАЦИЯ ТЕСТОВ =====

        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация поиска тестов
            var testsSearchInput = document.getElementById('testsSearchInput');
            if (testsSearchInput) {
                testsSearchInput.addEventListener('input', function() {
                    var clearBtn = document.getElementById('clearTestsSearch');
                    if (clearBtn) {
                        clearBtn.style.display = this.value ? 'block' : 'none';
                    }
                });
            }
    
            // Подсчитываем тесты при загрузке
            updateTestsCount();
        });

        function filterTests() {
            var searchInput = document.getElementById('testsSearchInput');
            if (!searchInput) return;

            var searchText = searchInput.value.toLowerCase().trim();
            var selectedType = document.querySelector('input[name="testTypeFilter"]:checked')?.value || 'all';
    
            console.log('🔍 Фильтрация тестов:', { searchText, selectedType });

            var rows = document.querySelectorAll('.test-row');
            var visibleCount = 0;

            rows.forEach(function(row) {
                var rowSearchText = row.getAttribute('data-search-text') || '';
                var rowTestType = row.getAttribute('data-test-type') || '';
        
                var matchesSearch = !searchText || rowSearchText.includes(searchText);
                var matchesType = selectedType === 'all' || rowTestType === selectedType;
        
                if (matchesSearch && matchesType) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            var noResults = document.getElementById('noTestsResults');
            var tableBody = document.getElementById('testsTableBody');
    
            if (visibleCount === 0 && (searchText || selectedType !== 'all')) {
                if (tableBody) tableBody.style.display = 'none';
                if (noResults) noResults.style.display = 'block';
            } else {
                if (tableBody) tableBody.style.display = '';
                if (noResults) noResults.style.display = 'none';
            }

            updateTestsCount(visibleCount);
            console.log('✅ Фильтрация завершена. Показано:', visibleCount, 'из', rows.length);
        }

        function clearTestsSearch() {
            var searchInput = document.getElementById('testsSearchInput');
            var clearBtn = document.getElementById('clearTestsSearch');
            var filterAll = document.getElementById('filterAll');
    
            if (searchInput) {
                searchInput.value = '';
            }
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
            if (filterAll) {
                filterAll.checked = true;
            }
    
            filterTests();
        }

        function updateTestsCount(count) {
            var countElement = document.getElementById('testsCount');
            if (countElement) {
                if (count === undefined) {
                    var total = document.querySelectorAll('.test-row').length;
                    countElement.textContent = 'Всего: ' + total;
                } else {
                    var total = document.querySelectorAll('.test-row').length;
                    countElement.textContent = 'Показано: ' + count + (count !== total ? ' из ' + total : '');
                }
            }
        }
    </script>
}
